!function(t,e,r){"undefined"!=typeof module&&module.exports?module.exports=e():"function"==typeof r.define&&r.define.amd?define(e):r.Firepad=e()}(0,function(){(t=t||{}).utils={},t.utils.makeEventEmitter=function(t,e){t.prototype.allowedEvents_=e,t.prototype.on=function(t,e,r){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{},this.eventListeners_[t]=this.eventListeners_[t]||[],this.eventListeners_[t].push({callback:e,context:r})},t.prototype.off=function(t,e){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{};for(var r=this.eventListeners_[t]||[],n=0;n<r.length;n++)if(r[n].callback===e)return void r.splice(n,1)},t.prototype.trigger=function(t){this.eventListeners_=this.eventListeners_||{};for(var e=this.eventListeners_[t]||[],r=0;r<e.length;r++)e[r].callback.apply(e[r].context,Array.prototype.slice.call(arguments,1))},t.prototype.validateEventType_=function(t){if(this.allowedEvents_){for(var e=!1,r=0;r<this.allowedEvents_.length;r++)if(this.allowedEvents_[r]===t){e=!0;break}if(!e)throw new Error('Unknown event "'+t+'"')}}},t.utils.elt=function(e,r,n){var i=document.createElement(e);if("string"==typeof r)t.utils.setTextContent(i,r);else if(r)for(var o=0;o<r.length;++o)i.appendChild(r[o]);for(var s in n||{})i.setAttribute(s,n[s]);return i},t.utils.setTextContent=function(t,e){t.innerHTML="",t.appendChild(document.createTextNode(e))},t.utils.on=function(t,e,r,n){t.addEventListener?t.addEventListener(e,r,n||!1):t.attachEvent&&t.attachEvent("on"+e,r)},t.utils.off=function(t,e,r,n){t.removeEventListener?t.removeEventListener(e,r,n||!1):t.detachEvent&&t.detachEvent("on"+e,r)},t.utils.preventDefault=function(t){t.preventDefault?t.preventDefault():t.returnValue=!1},t.utils.stopPropagation=function(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0},t.utils.stopEvent=function(e){t.utils.preventDefault(e),t.utils.stopPropagation(e)},t.utils.stopEventAnd=function(e){return function(r){return e(r),t.utils.stopEvent(r),!1}},t.utils.trim=function(t){return t.replace(/^\s+/g,"").replace(/\s+$/g,"")},t.utils.stringEndsWith=function(t,e){for(var r="string"==typeof e?[e]:e,n=0;n<r.length;n++){e=r[n];if(-1!==t.indexOf(e,t.length-e.length))return!0}return!1},t.utils.assert=function(t,e){if(!t)throw new Error(e||"assertion error")},t.utils.log=function(){if("undefined"!=typeof console&&void 0!==console.log){for(var t=["Firepad:"],e=0;e<arguments.length;e++)t.push(arguments[e]);console.log.apply(console,t)}},(t=t||{}).Span=function(){function t(t,e){this.pos=t,this.length=e}return t.prototype.end=function(){return this.pos+this.length},t}(),(t=t||{}).TextOp=function(){var e=t.utils;function r(t){this.type=t,this.chars=null,this.text=null,this.attributes=null,"insert"===t?(this.text=arguments[1],e.assert("string"==typeof this.text),this.attributes=arguments[2]||{},e.assert("object"==typeof this.attributes)):"delete"===t?(this.chars=arguments[1],e.assert("number"==typeof this.chars)):"retain"===t&&(this.chars=arguments[1],e.assert("number"==typeof this.chars),this.attributes=arguments[2]||{},e.assert("object"==typeof this.attributes))}return r.prototype.isInsert=function(){return"insert"===this.type},r.prototype.isDelete=function(){return"delete"===this.type},r.prototype.isRetain=function(){return"retain"===this.type},r.prototype.equals=function(t){return this.type===t.type&&this.text===t.text&&this.chars===t.chars&&this.attributesEqual(t.attributes)},r.prototype.attributesEqual=function(t){for(var e in this.attributes)if(this.attributes[e]!==t[e])return!1;for(e in t)if(this.attributes[e]!==t[e])return!1;return!0},r.prototype.hasEmptyAttributes=function(){var t=!0;for(var e in this.attributes){t=!1;break}return t},r}(),(t=t||{}).TextOperation=function(){"use strict";var e=t.TextOp,r=t.utils;function n(){if(!this||this.constructor!==n)return new n;this.ops=[],this.baseLength=0,this.targetLength=0}function i(t){var e=t.ops;switch(e.length){case 1:return e[0];case 2:return e[0].isRetain()?e[1]:e[1].isRetain()?e[0]:null;case 3:if(e[0].isRetain()&&e[2].isRetain())return e[1]}return null}function o(t){return t.ops[0].isRetain()?t.ops[0].chars:0}return n.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;e<this.ops.length;e++)if(!this.ops[e].equals(t.ops[e]))return!1;return!0},n.prototype.retain=function(t,r){if("number"!=typeof t||t<0)throw new Error("retain expects a positive integer.");if(0===t)return this;this.baseLength+=t,this.targetLength+=t,r=r||{};var n=this.ops.length>0?this.ops[this.ops.length-1]:null;return n&&n.isRetain()&&n.attributesEqual(r)?n.chars+=t:this.ops.push(new e("retain",t,r)),this},n.prototype.insert=function(t,r){if("string"!=typeof t)throw new Error("insert expects a string");if(""===t)return this;r=r||{},this.targetLength+=t.length;var n=this.ops.length>0?this.ops[this.ops.length-1]:null,i=this.ops.length>1?this.ops[this.ops.length-2]:null;return n&&n.isInsert()&&n.attributesEqual(r)?n.text+=t:n&&n.isDelete()?i&&i.isInsert()&&i.attributesEqual(r)?i.text+=t:(this.ops[this.ops.length-1]=new e("insert",t,r),this.ops.push(n)):this.ops.push(new e("insert",t,r)),this},n.prototype.delete=function(t){if("string"==typeof t&&(t=t.length),"number"!=typeof t||t<0)throw new Error("delete expects a positive integer or a string");if(0===t)return this;this.baseLength+=t;var r=this.ops.length>0?this.ops[this.ops.length-1]:null;return r&&r.isDelete()?r.chars+=t:this.ops.push(new e("delete",t)),this},n.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes()},n.prototype.clone=function(){for(var t=new n,e=0;e<this.ops.length;e++)this.ops[e].isRetain()?t.retain(this.ops[e].chars,this.ops[e].attributes):this.ops[e].isInsert()?t.insert(this.ops[e].text,this.ops[e].attributes):t.delete(this.ops[e].chars);return t},n.prototype.toString=function(){return(Array.prototype.map||function(t){for(var e=[],r=0,n=this.length;r<n;r++)e[r]=t(this[r]);return e}).call(this.ops,function(t){return t.isRetain()?"retain "+t.chars:t.isInsert()?"insert '"+t.text+"'":"delete "+t.chars}).join(", ")},n.prototype.toJSON=function(){for(var t=[],e=0;e<this.ops.length;e++)this.ops[e].hasEmptyAttributes()||t.push(this.ops[e].attributes),"retain"===this.ops[e].type?t.push(this.ops[e].chars):"insert"===this.ops[e].type?t.push(this.ops[e].text):"delete"===this.ops[e].type&&t.push(-this.ops[e].chars);return 0===t.length&&t.push(0),t},n.fromJSON=function(t){for(var e=new n,i=0,o=t.length;i<o;i++){var s=t[i],a={};"object"==typeof s&&(a=s,s=t[++i]),"number"==typeof s?s>0?e.retain(s,a):e.delete(-s):(r.assert("string"==typeof s),e.insert(s,a))}return e},n.prototype.apply=function(t,e,n){if(e=e||[],n=n||[],t.length!==this.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var i,o,s=[],a=0,h=0,u=this.ops,c=0,l=u.length;c<l;c++){var p=u[c];if(p.isRetain()){if(h+p.chars>t.length)throw new Error("Operation can't retain more characters than are left in the string.");for(s[a++]=t.slice(h,h+p.chars),i=0;i<p.chars;i++){var d=e[h+i]||{},f={};for(o in d)f[o]=d[o],r.assert(!1!==f[o]);for(o in p.attributes)!1===p.attributes[o]?delete f[o]:f[o]=p.attributes[o],r.assert(!1!==f[o]);n.push(f)}h+=p.chars}else if(p.isInsert())for(s[a++]=p.text,i=0;i<p.text.length;i++){var g={};for(o in p.attributes)g[o]=p.attributes[o],r.assert(!1!==g[o]);n.push(g)}else h+=p.chars}if(h!==t.length)throw new Error("The operation didn't operate on the whole string.");var m=s.join("");return r.assert(m.length===n.length),m},n.prototype.invert=function(t){for(var e=0,r=new n,i=this.ops,o=0,s=i.length;o<s;o++){var a=i[o];a.isRetain()?(r.retain(a.chars),e+=a.chars):a.isInsert()?r.delete(a.text.length):(r.insert(t.slice(e,e+a.chars)),e+=a.chars)}return r},n.prototype.compose=function(t){if(this.targetLength!==t.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");function e(t,e,r){var n,i={};for(n in t)i[n]=t[n];for(n in e)r&&!1===e[n]?delete i[n]:i[n]=e[n];return i}for(var r,i=new n,o=this.clone().ops,s=t.clone().ops,a=0,h=0,u=o[a++],c=s[h++];void 0!==u||void 0!==c;)if(u&&u.isDelete())i.delete(u.chars),u=o[a++];else if(c&&c.isInsert())i.insert(c.text,c.attributes),c=s[h++];else{if(void 0===u)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===c)throw new Error("Cannot compose operations: first operation is too long.");if(u.isRetain()&&c.isRetain())r=e(u.attributes,c.attributes),u.chars>c.chars?(i.retain(c.chars,r),u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(i.retain(u.chars,r),u=o[a++],c=s[h++]):(i.retain(u.chars,r),c.chars-=u.chars,u=o[a++]);else if(u.isInsert()&&c.isDelete())u.text.length>c.chars?(u.text=u.text.slice(c.chars),c=s[h++]):u.text.length===c.chars?(u=o[a++],c=s[h++]):(c.chars-=u.text.length,u=o[a++]);else if(u.isInsert()&&c.isRetain())r=e(u.attributes,c.attributes,!0),u.text.length>c.chars?(i.insert(u.text.slice(0,c.chars),r),u.text=u.text.slice(c.chars),c=s[h++]):u.text.length===c.chars?(i.insert(u.text,r),u=o[a++],c=s[h++]):(i.insert(u.text,r),c.chars-=u.text.length,u=o[a++]);else{if(!u.isRetain()||!c.isDelete())throw new Error("This shouldn't happen: op1: "+JSON.stringify(u)+", op2: "+JSON.stringify(c));u.chars>c.chars?(i.delete(c.chars),u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(i.delete(c.chars),u=o[a++],c=s[h++]):(i.delete(u.chars),c.chars-=u.chars,u=o[a++])}}return i},n.prototype.shouldBeComposedWith=function(t){if(this.isNoop()||t.isNoop())return!0;var e=o(this),r=o(t),n=i(this),s=i(t);return!(!n||!s)&&(n.isInsert()&&s.isInsert()?e+n.text.length===r:!(!n.isDelete()||!s.isDelete())&&(r+s.chars===e||e===r))},n.prototype.shouldBeComposedWithInverted=function(t){if(this.isNoop()||t.isNoop())return!0;var e=o(this),r=o(t),n=i(this),s=i(t);return!(!n||!s)&&(n.isInsert()&&s.isInsert()?e+n.text.length===r||e===r:!(!n.isDelete()||!s.isDelete())&&r+s.chars===e)},n.transformAttributes=function(t,e){var n,i={},o={},s={};for(n in t)s[n]=!0;for(n in e)s[n]=!0;for(n in s){var a=t[n],h=e[n];r.assert(null!=a||null!=h),null==a?o[n]=h:null==h?i[n]=a:a===h||(i[n]=a)}return[i,o]},n.transform=function(t,e){if(t.baseLength!==e.baseLength)throw new Error("Both operations have to have the same base length");for(var r=new n,i=new n,o=t.clone().ops,s=e.clone().ops,a=0,h=0,u=o[a++],c=s[h++];void 0!==u||void 0!==c;)if(u&&u.isInsert())r.insert(u.text,u.attributes),i.retain(u.text.length),u=o[a++];else if(c&&c.isInsert())r.retain(c.text.length),i.insert(c.text,c.attributes),c=s[h++];else{if(void 0===u)throw new Error("Cannot transform operations: first operation is too short.");if(void 0===c)throw new Error("Cannot transform operations: first operation is too long.");var l;if(u.isRetain()&&c.isRetain()){var p=n.transformAttributes(u.attributes,c.attributes);u.chars>c.chars?(l=c.chars,u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(l=c.chars,u=o[a++],c=s[h++]):(l=u.chars,c.chars-=u.chars,u=o[a++]),r.retain(l,p[0]),i.retain(l,p[1])}else if(u.isDelete()&&c.isDelete())u.chars>c.chars?(u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(u=o[a++],c=s[h++]):(c.chars-=u.chars,u=o[a++]);else if(u.isDelete()&&c.isRetain())u.chars>c.chars?(l=c.chars,u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(l=c.chars,u=o[a++],c=s[h++]):(l=u.chars,c.chars-=u.chars,u=o[a++]),r.delete(l);else{if(!u.isRetain()||!c.isDelete())throw new Error("The two operations aren't compatible");u.chars>c.chars?(l=c.chars,u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(l=u.chars,u=o[a++],c=s[h++]):(l=u.chars,c.chars-=u.chars,u=o[a++]),i.delete(l)}}return[r,i]},n.prototype.transform=function(t){return n.transform(this,t)},n}(),(t=t||{}).AnnotationList=function(){var e=t.Span;function r(t,e){if(!t)throw new Error("AnnotationList assertion failed"+(e?": "+e:""))}function n(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.attachedObject_=e.attachedObject}function i(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.node_=e}n.prototype.getAttachedObject=function(){return this.attachedObject_},i.prototype.attachObject=function(t){this.node_.attachedObject=t};var o={equals:function(){return!1}};function s(t){this.head_=new a(0,o),this.changeHandler_=t}function a(t,e){this.length=t,this.annotation=e,this.attachedObject=null,this.next=null}return s.prototype.insertAnnotatedSpan=function(t,n){this.wrapOperation_(new e(t.pos,0),function(e,i){r(!i||null===i.next);var s=new a(t.length,n);if(i){r(t.pos>e&&t.pos<e+i.length);var h=new a(0,o);return h.next=new a(t.pos-e,i.annotation),h.next.next=s,s.next=new a(e+i.length-t.pos,i.annotation),h.next}return s})},s.prototype.removeSpan=function(t){0!==t.length&&this.wrapOperation_(t,function(e,n){r(null!==n);var i=new a(0,o),s=i;for(t.pos>e&&(s.next=new a(t.pos-e,n.annotation),s=s.next);t.end()>e+n.length;)e+=n.length,n=n.next;var h=e+n.length-t.end();return h>0&&(s.next=new a(h,n.annotation)),i.next})},s.prototype.updateSpan=function(t,e){0!==t.length&&this.wrapOperation_(t,function(n,i){r(null!==i);var s=new a(0,o),h=s,u=n,c=t.pos-u;for(r(c<i.length),c>0&&(h.next=new a(c,i.annotation),u+=(h=h.next).length);null!==i&&t.end()>=n+i.length;){var l=n+i.length-u;h.next=new a(l,e(i.annotation,l)),h=h.next,n+=i.length,i=i.next,u=n}var p=t.end()-u;return p>0&&(r(p<i.length),h.next=new a(p,e(i.annotation,p)),u+=(h=h.next).length,h.next=new a(n+i.length-u,i.annotation)),s.next})},s.prototype.wrapOperation_=function(t,e){if(t.pos<0)throw new Error("Span start cannot be negative.");var r,o=[],s=[],h=this.getAffectedNodes_(t);null!==h.start?(r=h.end.next,h.end.next=null):r=h.succ;var u=e(h.startPos,h.start),c=!1,l=!1;if(u){var p;for(this.mergeNodesWithSameAnnotations_(u),h.pred&&h.pred.annotation.equals(u.annotation)?(c=!0,u.length+=h.pred.length,h.beforePred.next=u,p=h.predPos):(h.beforeStart.next=u,p=h.startPos);u.next;)s.push(new i(p,u)),p+=u.length,u=u.next;h.succ&&h.succ.annotation.equals(u.annotation)?(u.length+=h.succ.length,l=!0,u.next=h.succ.next):u.next=r,s.push(new i(p,u))}else h.pred&&h.succ&&h.pred.annotation.equals(h.succ.annotation)?(c=!0,l=!0,u=new a(h.pred.length+h.succ.length,h.pred.annotation),h.beforePred.next=u,u.next=h.succ.next,s.push(new i(h.startPos-h.pred.length,u))):h.beforeStart.next=r;c&&o.push(new n(h.predPos,h.pred));for(var d=h.startPos,f=h.start;null!==f;)o.push(new n(d,f)),d+=f.length,f=f.next;l&&o.push(new n(d,h.succ)),this.changeHandler_(o,s)},s.prototype.getAffectedNodes_=function(t){for(var e={},r=null,n=this.head_,i=n.next,o=0;null!==i&&t.pos>=o+i.length;)o+=i.length,r=n,n=i,i=i.next;if(null===i&&(0!==t.length||t.pos!==o))throw new Error("Span start exceeds the bounds of the AnnotationList.");for(e.startPos=o,0===t.length&&t.pos===o?e.start=null:e.start=i,e.beforeStart=n,o===t.pos&&o>0?(e.pred=n,e.predPos=o-n.length,e.beforePred=r):e.pred=null;null!==i&&t.end()>o;)o+=i.length,n=i,i=i.next;if(t.end()>o)throw new Error("Span end exceeds the bounds of the AnnotationList.");return 0===t.length&&t.end()===o?e.end=null:e.end=n,e.succ=o===t.end()?i:null,e},s.prototype.mergeNodesWithSameAnnotations_=function(t){if(t)for(var e=null,r=t;r;)e&&e.annotation.equals(r.annotation)?(e.length+=r.length,e.next=r.next):e=r,r=r.next},s.prototype.forEach=function(t){for(var e=this.head_.next;null!==e;)t(e.length,e.annotation,e.attachedObject),e=e.next},s.prototype.getAnnotatedSpansForPos=function(t){for(var e=0,r=this.head_.next,i=null;null!==r&&e+r.length<=t;)e+=r.length,i=r,r=r.next;if(null===r&&e!==t)throw new Error("pos exceeds the bounds of the AnnotationList");var o=[];return e===t&&i&&o.push(new n(e-i.length,i)),r&&o.push(new n(e,r)),o},s.prototype.getAnnotatedSpansForSpan=function(t){if(0===t.length)return[];for(var r=[],n=this.getAffectedNodes_(t),i=n.startPos,o=n.start;null!==o&&i<t.end();){var s=Math.max(i,t.pos),a=Math.min(i+o.length,t.end()),h=new e(s,a-s);h.annotation=o.annotation,r.push(h),i+=o.length,o=o.next}return r},s.prototype.count=function(){for(var t=0,e=this.head_.next,n=null;null!==e;)n&&r(!n.annotation.equals(e.annotation)),n=e,e=e.next,t++;return t},a.prototype.clone=function(){var t=new a(this.spanLength,this.annotation);return t.next=this.next,t},s}(),(t=t||{}).Cursor=function(){"use strict";function t(t,e){this.position=t,this.selectionEnd=e}return t.fromJSON=function(e){return new t(e.position,e.selectionEnd)},t.prototype.equals=function(t){return this.position===t.position&&this.selectionEnd===t.selectionEnd},t.prototype.compose=function(t){return t},t.prototype.transform=function(e){function r(t){for(var r=t,n=e.ops,i=0,o=e.ops.length;i<o&&(n[i].isRetain()?t-=n[i].chars:n[i].isInsert()?r+=n[i].text.length:(r-=Math.min(t,n[i].chars),t-=n[i].chars),!(t<0));i++);return r}var n=r(this.position);return this.position===this.selectionEnd?new t(n,n):new t(n,r(this.selectionEnd))},t}(),(t=t||{}).FirebaseAdapter=function(e){var r=t.TextOperation,n=t.utils;function i(t,e,n,i){this.ref_=t,this.ready_=!1,this.firebaseCallbacks_=[],this.zombie_=!1,this.document_=new r,this.revision_=0,this.pendingReceivedRevisions_={};var o=this;if(e){this.setUserId(e),this.setColor(n),this.setDisplayName(i);var s=t.root.child(".info/connected");this.firebaseOn_(s,"value",function(t){!0===t.val()&&o.initializeUserData_()},this),this.on("ready",function(){o.monitorCursors_()})}else this.userId_=t.push().key;setTimeout(function(){o.monitorHistory_()},0)}function o(t,e){if(!t)throw new Error(e||"assertion error")}n.makeEventEmitter(i,["ready","cursor","operation","ack","retry"]),i.prototype.dispose=function(){var t=this;this.ready_?(this.removeFirebaseCallbacks_(),this.userRef_&&(this.userRef_.child("cursor").remove(),this.userRef_.child("color").remove(),this.userRef_.child("displayName").remove()),this.ref_=null,this.document_=null,this.zombie_=!0):this.on("ready",function(){t.dispose()})},i.prototype.setUserId=function(t){this.userRef_&&(this.userRef_.child("cursor").remove(),this.userRef_.child("cursor").onDisconnect().cancel(),this.userRef_.child("color").remove(),this.userRef_.child("color").onDisconnect().cancel(),this.userRef_.child("displayName").remove(),this.userRef_.child("displayName").onDisconnect().cancel()),this.userId_=t,this.userRef_=this.ref_.child("users").child(t),this.initializeUserData_()},i.prototype.isHistoryEmpty=function(){return o(this.ready_,"Not ready yet."),0===this.revision_},i.prototype.sendOperation=function(t,e){var r=this;if(this.ready_){o(this.document_.targetLength===t.baseLength,"sendOperation() called with invalid operation.");var i=a(this.revision_);this.sent_={id:i,op:t},function t(i,o){r.ref_.child("history").child(i).transaction(function(t){if(null===t)return o},function(s,a,h){if(s){if("disconnect"!==s.message)throw n.log("Transaction failure!",s),s;r.sent_&&r.sent_.id===i?setTimeout(function(){t(i,o)},0):e&&e(s,!1)}else e&&e(null,a)},!1)}(i,{a:r.userId_,o:t.toJSON(),t:firebase.database.ServerValue.TIMESTAMP})}else this.on("ready",function(){r.trigger("retry")})},i.prototype.sendCursor=function(t){this.userRef_.child("cursor").set(t),this.cursor_=t},i.prototype.setColor=function(t){this.userRef_.child("color").set(t),this.color_=t},i.prototype.setDisplayName=function(t){this.userRef_.child("displayName").set(t),this.displayName_=t},i.prototype.getDocument=function(){return this.document_},i.prototype.registerCallbacks=function(t){for(var e in t)this.on(e,t[e])},i.prototype.initializeUserData_=function(){this.userRef_.child("cursor").onDisconnect().remove(),this.userRef_.child("color").onDisconnect().remove(),this.userRef_.child("displayName").onDisconnect().remove(),this.sendCursor(this.cursor_||null),this.setColor(this.color_||null),this.setDisplayName(this.displayName_||null)},i.prototype.monitorCursors_=function(){var t=this.ref_.child("users"),e=this;function r(t){var r=t.key,n=t.val();e.trigger("cursor",r,n.cursor,n.color,n.displayName)}this.firebaseOn_(t,"child_added",r),this.firebaseOn_(t,"child_changed",r),this.firebaseOn_(t,"child_removed",function(t){var r=t.key;e.trigger("cursor",r,null)})},i.prototype.deleteOldRevisions_=function(t){var e=this;t.once("value",function(r){if(void 0===r.val()||null===r.val()||!r.hasChildren())return;const i=Object.keys(r.val()).length;n.log("firepad revision history length: ",i),i>1e4?n.log("History too large to clean up!"):(r.forEach(function(t){t.ref.remove()}),setTimeout(function(){e.deleteOldRevisions_(t)},1e3))})},i.prototype.monitorHistory_=function(){var t=this;t.ref_.child("checkpoint").once("value",function(e){if(!t.zombie_){var r=e.child("id").val(),n=e.child("o").val(),i=e.child("a").val();if(null!==n&&null!==r&&null!==i&&void 0!==n&&void 0!==r&&void 0!==i?(t.pendingReceivedRevisions_[r]={o:n,a:i},t.checkpointRevision_=function(t){o(t.length>0&&t[0]===s[t.length+8]);for(var e=0,r=1;r<t.length;r++)e*=s.length,e+=s.indexOf(t[r]);return e}(r),t.monitorHistoryStartingAt_(t.checkpointRevision_+1)):(t.checkpointRevision_=0,t.monitorHistoryStartingAt_(t.checkpointRevision_)),r){var a=t.ref_.child("history");a.child(r+"/t").once("value",function(e){if(void 0!==e.val()&&null!==e.val()){var r=e.val()-1728e5;t.deleteOldRevisions_(a.orderByChild("t").endAt(r))}})}}})},i.prototype.monitorHistoryStartingAt_=function(t){var e=this.ref_.child("history").startAt(null,a(t)),r=this;setTimeout(function(){r.firebaseOn_(e,"child_added",function(t){var e=t.key;r.pendingReceivedRevisions_[e]=t.val(),r.ready_&&r.handlePendingReceivedRevisions_()}),e.once("value",function(){r.handleInitialRevisions_()})},0)},i.prototype.handleInitialRevisions_=function(){o(!this.ready_,"Should not be called multiple times."),this.revision_=this.checkpointRevision_;for(var t=a(this.revision_),e=this.pendingReceivedRevisions_;null!=e[t];){var r=this.parseRevision_(e[t]);r?this.document_=this.document_.compose(r.operation):n.log("Invalid operation.",this.ref_.toString(),t,e[t]),delete e[t],this.revision_++,t=a(this.revision_)}this.trigger("operation",this.document_),this.ready_=!0;var i=this;setTimeout(function(){i.trigger("ready")},0)},i.prototype.handlePendingReceivedRevisions_=function(){for(var t=this.pendingReceivedRevisions_,e=a(this.revision_),r=!1;null!=t[e];){this.revision_++;var i=this.parseRevision_(t[e]);i?(this.document_=this.document_.compose(i.operation),this.sent_&&e===this.sent_.id?this.sent_.op.equals(i.operation)&&i.author===this.userId_?(this.revision_%100==0&&this.saveCheckpoint_(),this.sent_=null,this.trigger("ack")):(r=!0,this.trigger("operation",i.operation)):this.trigger("operation",i.operation)):n.log("Invalid operation.",this.ref_.toString(),e,t[e]),delete t[e],e=a(this.revision_)}r&&(this.sent_=null,this.trigger("retry"))},i.prototype.parseRevision_=function(t){if("object"!=typeof t)return null;if("string"!=typeof t.a||"object"!=typeof t.o)return null;var e=null;try{e=r.fromJSON(t.o)}catch(t){return null}return e.baseLength!==this.document_.targetLength?null:{author:t.a,operation:e}},i.prototype.saveCheckpoint_=function(){this.ref_.child("checkpoint").set({a:this.userId_,o:this.document_.toJSON(),id:a(this.revision_-1)})},i.prototype.firebaseOn_=function(t,e,r,n){return this.firebaseCallbacks_.push({ref:t,eventType:e,callback:r,context:n}),t.on(e,r,n),r},i.prototype.firebaseOff_=function(t,e,r,n){t.off(e,r,n);for(var i=0;i<this.firebaseCallbacks_.length;i++){var o=this.firebaseCallbacks_[i];if(o.ref===t&&o.eventType===e&&o.callback===r&&o.context===n){this.firebaseCallbacks_.splice(i,1);break}}},i.prototype.removeFirebaseCallbacks_=function(){for(var t=0;t<this.firebaseCallbacks_.length;t++){var e=this.firebaseCallbacks_[t];e.ref.off(e.eventType,e.callback,e.context)}this.firebaseCallbacks_=[]};var s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function a(t){if(0===t)return"A0";for(var e="";t>0;){var r=t%s.length;e=s[r]+e,t-=r,t/=s.length}return s[e.length+9]+e}return i}(),(t=t||{}).RichTextToolbar=function(e){var r=t.utils;function n(t,e){this.imageInsertionUI=t,this.showPrint=e,this.element_=this.makeElement_()}return r.makeEventEmitter(n,["bold","italic","underline","strike","font","font-size","color","left","center","right","unordered-list","ordered-list","todo-list","indent-increase","indent-decrease","undo","redo","insert-image","print"]),n.prototype.element=function(){return this.element_},n.prototype.makeButton_=function(t,e){var n=this;e=e||t;var i,o=r.elt("a",[r.elt("span","",{class:"firepad-tb-"+e})],{class:"firepad-btn",title:(i=t,i.charAt(0).toUpperCase()+i.slice(1))});return r.on(o,"click",r.stopEventAnd(function(){n.trigger(t)})),o},n.prototype.makeTextButton_=function(t,e){var n=this;e=e||t;var i=r.elt("a",[r.elt("span",e)],{class:"firepad-btn"});return r.on(i,"click",r.stopEventAnd(function(){n.trigger(t)})),i},n.prototype.makeElement_=function(){var t=this.makeFontDropdown_(),e=this.makeFontSizeDropdown_(),n=this.makeColorDropdown_(),i=[r.elt("div",[t],{class:"firepad-btn-group"}),r.elt("div",[e],{class:"firepad-btn-group"}),r.elt("div",[n],{class:"firepad-btn-group"}),r.elt("div",[this.makeButton_("bold"),this.makeButton_("italic"),this.makeButton_("underline"),this.makeButton_("strike","strikethrough")],{class:"firepad-btn-group"}),r.elt("div",[this.makeButton_("unordered-list","list-2"),this.makeButton_("ordered-list","numbered-list")],{class:"firepad-btn-group"}),r.elt("div",[this.makeButton_("indent-decrease"),this.makeButton_("indent-increase")],{class:"firepad-btn-group"}),r.elt("div",[this.makeButton_("left","paragraph-left"),this.makeButton_("center","paragraph-center"),this.makeButton_("right","paragraph-right")],{class:"firepad-btn-group"}),r.elt("div",[this.makeButton_("undo"),this.makeButton_("redo")],{class:"firepad-btn-group"})];this.showPrint&&i.push(r.elt("div",[this.makeButton_("print")],{class:"firepad-btn-group"})),this.imageInsertionUI&&i.push(r.elt("div",[this.makeButton_("insert-image")],{class:"firepad-btn-group"})),this.linesRemaining=r.elt("div","",{class:"firepad-toolbar-linesremaining-label"}),i.push(this.linesRemaining);var o=r.elt("div",i,{class:"firepad-toolbar-wrapper"}),s=r.elt("div",null,{class:"firepad-toolbar"});return s.appendChild(o),s},n.prototype.updateLinesRemaining=function(t){this.linesRemaining.innerHTML=t<10?"Lines remaining: "+t:""},n.prototype.makeFontDropdown_=function(){for(var t=["Arial","Arial Black","Comic Sans MS","Courier New","Georgia","Impact","Lucida Console","Lucida Grande","Palatino","Print Practice","Tahoma","Times New Roman","Trebuchet MS","Verdana"],e=[],n=0;n<t.length;n++){var i=r.elt("span",t[n]);i.setAttribute("style","font-family:"+t[n]),e.push({content:i,value:t[n]})}return this.makeDropdown_("Font","font",e)},n.prototype.makeFontSizeDropdown_=function(){for(var t=[9,10,12,14,18,24,32,42],e=[],n=0;n<t.length;n++){var i=r.elt("span",t[n].toString());i.setAttribute("style","font-size:"+t[n]+"px; line-height:"+(t[n]-6)+"px;"),e.push({content:i,value:t[n]})}return this.makeDropdown_("Size","font-size",e,"px")},n.prototype.makeColorDropdown_=function(){for(var t=["#000000","#747678","#4D8BBE","#85D4F7","#D0021B","#F9B417","#78A240","#B665A6","#FF6C98"],e=[],n=0;n<t.length;n++){var i=r.elt("div");i.className="firepad-color-dropdown-item",i.setAttribute("style","background-color:"+t[n]),e.push({content:i,value:t[n]})}return this.makeDropdown_("Color","color",e)},n.prototype.makeDropdown_=function(t,e,n,i){i=i||"";var o=this,s=r.elt("a",t+" ▾",{class:"firepad-btn firepad-dropdown"}),a=r.elt("ul",[],{class:"firepad-dropdown-menu"});s.appendChild(a);var h=!1;var u=!1;function c(){h&&(a.style.display="",r.off(document,"click",c,!0),h=!1),u=!0,setTimeout(function(){u=!1},0)}function l(t,n){"object"!=typeof t&&(t=document.createTextNode(String(t)));var s=r.elt("a",[t]);r.on(s,"click",r.stopEventAnd(function(){c(),o.trigger(e,n+i)})),a.appendChild(s)}for(var p=0;p<n.length;p++){l(n[p].content,n[p].value)}return r.on(s,"click",r.stopEventAnd(function(){u||h||(a.style.display="block",r.on(document,"click",c,!0),h=!0)})),s},n}(),(t=t||{}).WrappedOperation=function(t){"use strict";function e(t,e){this.wrapped=t,this.meta=e}function r(t,e){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])}function n(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return e.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},e.prototype.invert=function(){var t=this.meta;return new e(this.wrapped.invert.apply(this.wrapped,arguments),t&&"object"==typeof t&&"function"==typeof t.invert?t.invert.apply(t,arguments):t)},e.prototype.compose=function(t){return new e(this.wrapped.compose(t.wrapped),function(t,e){if(t&&"object"==typeof t){if("function"==typeof t.compose)return t.compose(e);var n={};return r(t,n),r(e,n),n}return e}(this.meta,t.meta))},e.transform=function(t,r){var i=t.wrapped.transform(r.wrapped);return[new e(i[0],n(t.meta,r.wrapped)),new e(i[1],n(r.meta,t.wrapped))]},e.prototype.transform=function(t){return e.transform(this,t)},e}(),(t=t||{}).UndoManager=function(){"use strict";var t="normal";function e(e){this.maxItems=e||50,this.state=t,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function r(t,e){for(var r=[],n=e.constructor,i=t.length-1;i>=0;i--){var o=n.transform(t[i],e);"function"==typeof o[0].isNoop&&o[0].isNoop()||r.push(o[0]),e=o[1]}return r.reverse()}return e.prototype.add=function(t,e){if("undoing"===this.state)this.redoStack.push(t),this.dontCompose=!0;else if("redoing"===this.state)this.undoStack.push(t),this.dontCompose=!0;else{var r=this.undoStack;!this.dontCompose&&e&&r.length>0?r.push(t.compose(r.pop())):(r.push(t),r.length>this.maxItems&&r.shift()),this.dontCompose=!1,this.redoStack=[]}},e.prototype.transform=function(t){this.undoStack=r(this.undoStack,t),this.redoStack=r(this.redoStack,t)},e.prototype.performUndo=function(e){if(this.state="undoing",0===this.undoStack.length)throw new Error("undo not possible");e(this.undoStack.pop()),this.state=t},e.prototype.performRedo=function(e){if(this.state="redoing",0===this.redoStack.length)throw new Error("redo not possible");e(this.redoStack.pop()),this.state=t},e.prototype.canUndo=function(){return 0!==this.undoStack.length},e.prototype.canRedo=function(){return 0!==this.redoStack.length},e.prototype.isUndoing=function(){return"undoing"===this.state},e.prototype.isRedoing=function(){return"redoing"===this.state},e}(),(t=t||{}).Client=function(){"use strict";function t(){this.state=r}function e(){}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t){this.setState(this.state.applyServer(this,t))},t.prototype.serverAck=function(){this.setState(this.state.serverAck(this))},t.prototype.serverRetry=function(){this.setState(this.state.serverRetry(this))},t.prototype.sendOperation=function(t){throw new Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(t){throw new Error("applyOperation must be defined in child class")},t.Synchronized=e,e.prototype.applyClient=function(t,e){return t.sendOperation(e),new n(e)},e.prototype.applyServer=function(t,e){return t.applyOperation(e),this},e.prototype.serverAck=function(t){throw new Error("There is no pending operation.")},e.prototype.serverRetry=function(t){throw new Error("There is no pending operation.")};var r=new e;function n(t){this.outstanding=t}function i(t,e){this.outstanding=t,this.buffer=e}return t.AwaitingConfirm=n,n.prototype.applyClient=function(t,e){return new i(this.outstanding,e)},n.prototype.applyServer=function(t,e){var r=this.outstanding.transform(e);return t.applyOperation(r[1]),new n(r[0])},n.prototype.serverAck=function(t){return r},n.prototype.serverRetry=function(t){return t.sendOperation(this.outstanding),this},t.AwaitingWithBuffer=i,i.prototype.applyClient=function(t,e){var r=this.buffer.compose(e);return new i(this.outstanding,r)},i.prototype.applyServer=function(t,e){var r=this.outstanding.transform(e),n=this.buffer.transform(r[1]);return t.applyOperation(n[1]),new i(r[0],n[0])},i.prototype.serverRetry=function(t){var e=this.outstanding.compose(this.buffer);return t.sendOperation(e),new n(e)},i.prototype.serverAck=function(t){return t.sendOperation(this.buffer),new n(this.buffer)},t}(),(t=t||{}).EditorClient=function(){"use strict";var e=t.Client,r=t.Cursor,n=t.UndoManager,i=t.WrappedOperation;function o(t,e){this.cursorBefore=t,this.cursorAfter=e}function s(t,e){this.id=t,this.editorAdapter=e}function a(t,i){e.call(this),this.serverAdapter=t,this.editorAdapter=i,this.undoManager=new n,this.clients={};var o=this;this.editorAdapter.registerCallbacks({change:function(t,e){o.onChange(t,e)},cursorActivity:function(){o.onCursorActivity()},blur:function(){o.onBlur()},focus:function(){o.onFocus()}}),this.editorAdapter.registerUndo(function(){o.undo()}),this.editorAdapter.registerRedo(function(){o.redo()});var s=[];this.serverAdapter.registerCallbacks({ack:function(){o.serverAck(),o.focused&&o.state instanceof e.Synchronized&&(o.updateCursor(),o.sendCursor(o.cursor)),o.emitStatus()},retry:function(){o.serverRetry()},operation:function(t){o.applyServer(t)},cursor:function(t,n,i,a){if(o.serverAdapter.userId_!==t&&o.state instanceof e.Synchronized){var h=o.getClientObject(t);n?(i&&h.setColor(i),a&&h.setDisplayName(a),h.updateCursor(r.fromJSON(n)),function(t){s[t]&&clearTimeout(s[t]),s[t]=setTimeout(function(){o.getClientObject(t).removeCursor()},3e3)}(t)):h.removeCursor()}}})}return o.prototype.invert=function(){return new o(this.cursorAfter,this.cursorBefore)},o.prototype.compose=function(t){return new o(this.cursorBefore,t.cursorAfter)},o.prototype.transform=function(t){return new o(this.cursorBefore?this.cursorBefore.transform(t):null,this.cursorAfter?this.cursorAfter.transform(t):null)},s.prototype.setColor=function(t){this.color=t},s.prototype.setDisplayName=function(t){this.displayName=t},s.prototype.updateCursor=function(t){this.removeCursor(),this.cursor=t,this.mark=this.editorAdapter.setOtherCursor(t,this.color,this.id,this.displayName)},s.prototype.removeCursor=function(){this.mark&&this.mark.clear()},function(t,e){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t}(a,e),a.prototype.getClientObject=function(t){var e=this.clients[t];return e||(this.clients[t]=new s(t,this.editorAdapter))},a.prototype.applyUnredo=function(t){this.undoManager.add(this.editorAdapter.invertOperation(t)),this.editorAdapter.applyOperation(t.wrapped),this.cursor=t.meta.cursorAfter,this.cursor&&this.editorAdapter.setCursor(this.cursor),this.applyClient(t.wrapped)},a.prototype.undo=function(){var t=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(e){t.applyUnredo(e)})},a.prototype.redo=function(){var t=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(e){t.applyUnredo(e)})},a.prototype.onChange=function(t,e){var r=this.cursor;this.updateCursor();var n,s=this.undoManager.undoStack.length>0&&e.shouldBeComposedWithInverted((n=this.undoManager.undoStack,n[n.length-1]).wrapped),a=new o(this.cursor,r);this.undoManager.add(new i(e,a),s),this.applyClient(t)},a.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},a.prototype.onCursorActivity=function(){var t=this.cursor;this.updateCursor(),!this.focused||t&&this.cursor.equals(t)||this.sendCursor(this.cursor)},a.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null),this.focused=!1},a.prototype.onFocus=function(){this.focused=!0,this.onCursorActivity()},a.prototype.sendCursor=function(t){this.state instanceof e.AwaitingWithBuffer||this.serverAdapter.sendCursor(t)},a.prototype.sendOperation=function(t){this.serverAdapter.sendOperation(t),this.emitStatus()},a.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateCursor(),this.undoManager.transform(new i(t,null))},a.prototype.emitStatus=function(){var t=this;setTimeout(function(){t.trigger("synced",t.state instanceof e.Synchronized)},0)},a}(),t.utils.makeEventEmitter(t.EditorClient,["synced"]);var t,e=function(t,e,r){return"."+t+" {\n  position: relative;\nbackground-color: "+e+";\nborder-left: 2px solid "+r+";\n}"},r=function(t,e){if("undefined"==typeof document||null===document)return!1;if(-1===this.addedStyleRules.indexOf(t)){var r=document.createElement("style"),n=document.createTextNode(e);r.appendChild(n),document.head.appendChild(r),this.addedStyleRules.push(t)}},n=function(){function n(t){if(null!==t&&"undefined"!=typeof global&&global.monaco&&!t instanceof global.monaco)throw new Error("MonacoAdapter: Incorrect Parameter Recieved in constructor, expected valid Monaco Instance");this.monaco=t,this.monacoModel=this.monaco.getModel(),this.lastDocLines=this.monacoModel.getLinesContent(),this.lastCursorRange=this.monaco.getSelection(),this.callbacks={},this.otherCursors=[],this.addedStyleRules=[],this.ignoreChanges=!1,this.onChange=this.onChange.bind(this),this.onBlur=this.onBlur.bind(this),this.onFocus=this.onFocus.bind(this),this.onCursorActivity=this.onCursorActivity.bind(this),this.changeHandler=this.monaco.onDidChangeModelContent(this.onChange),this.didBlurHandler=this.monaco.onDidBlurEditorWidget(this.onBlur),this.didFocusHandler=this.monaco.onDidFocusEditorWidget(this.onFocus),this.didChangeCursorPositionHandler=this.monaco.onDidChangeCursorPosition(this.onCursorActivity)}return n.prototype.detach=function(){this.changeHandler.dispose(),this.didBlurHandler.dispose(),this.didFocusHandler.dispose(),this.didChangeCursorPositionHandler.dispose()},n.prototype.getCursor=function(){var e=this.monaco.getSelection();void 0!==e&&null!==e||(e=this.lastCursorRange);var r=e.getStartPosition(),n=e.getEndPosition(),i=this.monacoModel.getOffsetAt(r),o=this.monacoModel.getOffsetAt(n);if(i>o){var s=[o,i];i=s[0],o=s[1]}return new t.Cursor(i,o)},n.prototype.setCursor=function(t){var e=t.position,r=t.selectionEnd,n=this.monacoModel.getPositionAt(e),i=this.monacoModel.getPositionAt(r);if(e>r){var o=[i,n];n=o[0],i=o[1]}this.monaco.setSelection(new monaco.Range(n.lineNumber,n.column,i.lineNumber,i.column))},n.prototype.setOtherCursor=function(t,n,i){if("object"!=typeof t||"number"!=typeof t.position||"number"!=typeof t.selectionEnd)return!1;if("string"!=typeof n||!n.match(/^#[a-fA-F0-9]{3,6}$/))return!1;var o=t.position,s=t.selectionEnd;if(o<0||s<0)return!1;var a=this.otherCursors.find(function(t){return t.clientID===i});a||(a={clientID:i,decoration:[]},this.otherCursors.push(a)),a.decoration=this.monaco.deltaDecorations(a.decoration,[]);var h,u,c="other-client-selection-"+n.replace("#","");o===s?(c=c.replace("selection","cursor"),h=e(c,"transparent",n),u=r.call(this,c,h)):(h=e(c,n,n),u=r.call(this,c,h)),0==u&&console.log("Monaco Adapter: Failed to add some css style.\nPlease make sure you're running on supported environment.");var l=this.monacoModel.getPositionAt(o),p=this.monacoModel.getPositionAt(s);if(o>s){var d=[p,l];l=d[0],p=d[1]}a.decoration=this.monaco.deltaDecorations(a.decoration,[{range:new monaco.Range(l.lineNumber,l.column,p.lineNumber,p.column),options:{className:c}}]);var f=this;return{clear:function(){a.decoration=f.monaco.deltaDecorations(a.decoration,[])}}},n.prototype.registerCallbacks=function(t){this.callbacks=Object.assign({},this.callbacks,t)},n.prototype.registerUndo=function(t){if("function"!=typeof t)throw new Error("MonacoAdapter: registerUndo method expects a callback function in parameter");this.callbacks.undo=t},n.prototype.registerRedo=function(t){if("function"!=typeof t)throw new Error("MonacoAdapter: registerRedo method expects a callback function in parameter");this.callbacks.redo=t},n.prototype.operationFromMonacoChanges=function(e,r,n){var i,o,s,a=e.text,h=e.rangeLength,u=e.rangeOffset+n,c=r.length+n-u;return 0===a.length&&h>0?(s=r.slice(u,u+h),i=(new t.TextOperation).retain(u).delete(h).retain(c-h),o=(new t.TextOperation).retain(u).insert(s).retain(c-h)):a.length>0&&h>0?(s=r.slice(u,u+h),i=(new t.TextOperation).retain(u).delete(h).insert(a).retain(c-h),o=(new t.TextOperation).retain(u).delete(a.length).insert(s).retain(c-h)):(i=(new t.TextOperation).retain(u).insert(a).retain(c),o=(new t.TextOperation).retain(u).delete(a).retain(c)),[i,o]},n.prototype.onChange=function(e){var r=this;if(!this.ignoreChanges){var n=this.lastDocLines.join(this.monacoModel.getEOL()),i=0;if(!e.changes){var o=(new t.TextOperation).retain(n.length);this.trigger("change",o,o)}e.changes.reverse().forEach(function(t){var e=r.operationFromMonacoChanges(t,n,i);i+=e[0].targetLength-e[0].baseLength,r.trigger.apply(r,["change"].concat(e))}),this.lastDocLines=this.monacoModel.getLinesContent()}},n.prototype.trigger=function(t){if(this.callbacks.hasOwnProperty(t)){var e=this.callbacks[t];0;var r=[];if(arguments.length>1)for(var n=1;n<arguments.length;n++)r.push(arguments[n]);e.apply(null,r)}},n.prototype.onBlur=function(){this.monaco.getSelection().isEmpty()&&this.trigger("blur")},n.prototype.onFocus=function(){this.trigger("focus")},n.prototype.onCursorActivity=function(){var t=this;setTimeout(function(){return t.trigger("cursorActivity")},1)},n.prototype.applyOperation=function(t){t.isNoop()||(this.ignoreChanges=!0);var e=0,r=this;t.ops.forEach(function(t){if(t.isRetain())e+=t.chars;else if(t.isInsert()){var n=r.monacoModel.getPositionAt(e);r.monaco.executeEdits("my-source",[{range:new monaco.Range(n.lineNumber,n.column,n.lineNumber,n.column),text:t.text,forceMoveMarkers:!0}]),e+=t.text.length}else if(t.isDelete()){var i=r.monacoModel.getPositionAt(e),o=r.monacoModel.getPositionAt(e+t.chars);r.monaco.executeEdits("my-source",[{range:new monaco.Range(i.lineNumber,i.column,o.lineNumber,o.column),text:"",forceMoveMarkers:!0}])}}),this.lastDocLines=this.monacoModel.getLinesContent(),this.ignoreChanges=!1},n.prototype.invertOperation=function(t){t.invert(this.getValue())},n}();return t.MonacoAdapter=n,(t=t||{}).AttributeConstants={BOLD:"b",ITALIC:"i",UNDERLINE:"u",STRIKE:"s",FONT:"f",FONT_SIZE:"fs",COLOR:"c",BACKGROUND_COLOR:"bc",ENTITY_SENTINEL:"ent",LINE_SENTINEL:"l",LINE_INDENT:"li",LINE_ALIGN:"la",LIST_TYPE:"lt"},t.sentinelConstants={LINE_SENTINEL_CHARACTER:"",ENTITY_SENTINEL_CHARACTER:""},(t=t||{}).EntityManager=function(){var e=t.utils;function r(){this.entities_={};var t=["src","alt","width","height","style","class"];this.register("img",{render:function(t){e.assert(t.src,"image entity should have 'src'!");for(var r=["src","alt","width","height","style","class"],n="<img ",i=0;i<r.length;i++){var o=r[i];o in t&&(n+=" "+o+'="'+t[o]+'"')}return n+=">"},fromElement:function(e){for(var r={},n=0;n<t.length;n++){var i=t[n];e.hasAttribute(i)&&(r[i]=e.getAttribute(i))}return r}})}return r.prototype.register=function(e,r){t.utils.assert(r.render,"Entity options should include a 'render' function!"),t.utils.assert(r.fromElement,"Entity options should include a 'fromElement' function!"),this.entities_[e]=r},r.prototype.renderToElement=function(t,e){return this.tryRenderToElement_(t,"render",e)},r.prototype.exportToElement=function(t){var e=this.tryRenderToElement_(t,"export")||this.tryRenderToElement_(t,"getHtml")||this.tryRenderToElement_(t,"render");return e.setAttribute("data-firepad-entity",t.type),e},r.prototype.updateElement=function(t,e){var r=t.type,n=t.info;this.entities_[r]&&void 0!==this.entities_[r].update&&this.entities_[r].update(n,e)},r.prototype.fromElement=function(e){var r=e.getAttribute("data-firepad-entity");if(r||(r=e.nodeName.toLowerCase()),r&&this.entities_[r]){var n=this.entities_[r].fromElement(e);return new t.Entity(r,n)}},r.prototype.tryRenderToElement_=function(e,r,n){var i=e.type,o=e.info;if(this.entities_[i]&&this.entities_[i][r]){var s=t.document||window&&window.document,a=this.entities_[i][r](o,n,s);if(a){if("string"==typeof a){var h=(t.document||document).createElement("div");return h.innerHTML=a,h.childNodes[0]}if("object"==typeof a)return t.utils.assert(void 0!==a.nodeType,"Error rendering "+i+" entity.  render() function must return an html string or a DOM element."),a}}},r.prototype.entitySupportsUpdate=function(t){return this.entities_[t]&&this.entities_[t].update},r}(),(t=t||{}).Entity=function(){var e=t.AttributeConstants.ENTITY_SENTINEL,r=e+"_";function n(t,e){if(!(this instanceof n))return new n(t,e);this.type=t,this.info=e||{}}return n.prototype.toAttributes=function(){var t={};for(var n in t[e]=this.type,this.info)t[r+n]=this.info[n];return t},n.fromAttributes=function(t){var i=t[e],o={};for(var s in t)0===s.indexOf(r)&&(o[s.substr(r.length)]=t[s]);return new n(i,o)},n}(),(t=t||{}).RichTextCodeMirror=function(){var e=t.AnnotationList,r=t.Span,n=t.utils,i=t.AttributeConstants,o={c:"color",bc:"background-color",fs:"font-size",li:function(t){return"padding-left: "+40*t+"px"}},s={};function a(t,r,n){this.codeMirror=t,this.options_=n||{},this.entityManager_=r,this.currentAttributes_=null;var i=this;this.annotationList_=new e(function(t,e){i.onAnnotationsChanged_(t,e),i.fixBullets()}),this.initAnnotationList_(),m(this,"onCodeMirrorBeforeChange_"),m(this,"onCodeMirrorChange_"),m(this,"onCursorActivity_"),m(this,"onCodeMirrorCopyCut_"),m(this,"onCodeMirrorPaste_"),parseInt(CodeMirror.version)>=4?this.codeMirror.on("changes",this.onCodeMirrorChange_):this.codeMirror.on("change",this.onCodeMirrorChange_),this.codeMirror.on("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.on("cursorActivity",this.onCursorActivity_),this.codeMirror.on("copy",this.onCodeMirrorCopyCut_),this.codeMirror.on("cut",this.onCodeMirrorCopyCut_),this.codeMirror.on("paste",this.onCodeMirrorPaste_),this.changeId_=0,this.outstandingChanges_={},this.dirtyLines_=[]}n.makeEventEmitter(a,["change","attributesChange","newLine"]);var h=t.sentinelConstants.LINE_SENTINEL_CHARACTER,u=t.sentinelConstants.ENTITY_SENTINEL_CHARACTER;a.prototype.detach=function(){this.codeMirror.off("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.off("change",this.onCodeMirrorChange_),this.codeMirror.off("changes",this.onCodeMirrorChange_),this.codeMirror.off("cursorActivity",this.onCursorActivity_),this.codeMirror.off("copy",this.onCodeMirrorCopyCut_),this.codeMirror.off("cut",this.onCodeMirrorCopyCut_),this.codeMirror.off("paste",this.onCodeMirrorPaste_),this.clearAnnotations_()};var c=null;function l(t,e){return t.line-e.line||t.ch-e.ch}function p(t,e){return l(t,e)<=0}function d(t){if(0===t.length)return 0;for(var e=0,r=0;r<t.length;r++)e+=t[r].length;return e+t.length-1}function f(t,e,r){var n=new RegExp("(?:^|\\s)"+e+"(?!\\S)","g"),i=arguments.length>2?r:null===t.className.match(n);t.className=t.className.replace(n,""),i&&(t.className+=" "+e)}function g(t){this.attributes=t||{}}function m(t,e){var r=t[e];t[e]=function(){return r.apply(t,arguments)}}return a.prototype.fixBullets=function(){c||(c=setTimeout(function(){for(var t=document.getElementsByClassName("CodeMirror-widget"),e=0;e<t.length;e++){var r=t[e].getElementsByClassName("firepad-list-left")[0];if(r){var n=t[e].nextSibling;if(!n){var i=t[e].parentNode.parentNode.previousSibling;if(i){var o=i.getElementsByClassName("CodeMirror-widget")[0];if(o)o.getElementsByClassName("firepad-list-left")[0]&&(n=o.nextSibling)}}if(n&&n.classList&&n.classList.length>0){var s=n.classList;r.className="firepad-list-left";for(var a=0;a<s.length;a++)r.classList.add(s[a])}}}c=null},100))},a.prototype.toggleAttribute=function(t,e){var r=e||!0;if(this.emptySelection_()){var n=this.getCurrentAttributes_();n[t]===r?delete n[t]:n[t]=r,this.currentAttributes_=n,this.updateToolbarButnsState_()}else{var i=this.getCurrentAttributes_()[t]!==r&&r;this.setAttribute(t,i)}},a.prototype.setAttribute=function(t,e){var r=this.codeMirror;if(this.emptySelection_()){var n=this.getCurrentAttributes_();!1===e?delete n[t]:n[t]=e,this.currentAttributes_=n,this.updateToolbarButnsState_()}else this.updateTextAttributes(r.indexFromPos(r.getCursor("start")),r.indexFromPos(r.getCursor("end")),function(r){!1===e?delete r[t]:r[t]=e}),this.updateCurrentAttributes_()},a.prototype.updateTextAttributes=function(t,e,n,o,s){var a=[],h=t,u=this;this.annotationList_.updateSpan(new r(t,e-t),function(t,e){var r={};for(var c in t.attributes)r[c]=t.attributes[c];r[i.LINE_SENTINEL]&&!s||n(r);var l={},p={};return u.computeChangedAttributes_(t.attributes,r,l,p),function(t){for(var e in t)return!1;return!0}(l)||a.push({start:h,end:h+e,attributes:l,attributesInverse:p,origin:o}),h+=e,new g(r)}),a.length>0&&this.trigger("attributesChange",this,a)},a.prototype.computeChangedAttributes_=function(t,e,r,n){var i,o={};for(i in t)o[i]=!0;for(i in e)o[i]=!0;for(i in o)i in e?i in t?t[i]!==e[i]&&(r[i]=e[i],n[i]=t[i]):(r[i]=e[i],n[i]=!1):(r[i]=!1,n[i]=t[i])},a.prototype.toggleLineAttribute=function(t,e){var r,n=this.getCurrentLineAttributes_();r=!(t in n&&n[t]===e)&&e,this.setLineAttribute(t,r)},a.prototype.setLineAttribute=function(t,e){this.updateLineAttributesForSelection(function(r){!1===e?delete r[t]:r[t]=e})},a.prototype.updateLineAttributesForSelection=function(t){var e=this.codeMirror,r=e.getCursor("start"),n=e.getCursor("end"),i=r.line,o=n.line,s=e.getLine(o),a=this.areLineSentinelCharacters_(s.substr(0,n.ch));o>i&&a&&o--,this.updateLineAttributes(i,o,t)},a.prototype.updateLineAttributes=function(t,e,r){for(var n=t;n<=e;n++){var o=this.codeMirror.getLine(n),s=this.codeMirror.indexFromPos({line:n,ch:0});if(o[0]!==h){var a={};a[i.LINE_SENTINEL]=!0,r(a),this.insertText(s,h,a)}else this.updateTextAttributes(s,s+1,r,null,!0)}},a.prototype.replaceText=function(t,e,r,n,i){this.changeId_++;var o="cmrt-"+this.changeId_;this.outstandingChanges_[o]={origOrigin:i,attributes:n};var s=this.codeMirror,a=s.posFromIndex(t),h="number"==typeof e?s.posFromIndex(e):null;s.replaceRange(r,a,h,o)},a.prototype.insertText=function(t,e,r,n){var i=this.codeMirror,o=i.getCursor(),s="RTCMADAPTER"==n&&!i.somethingSelected()&&t==i.indexFromPos(o);this.replaceText(t,null,e,r,n),s&&i.setCursor(o)},a.prototype.removeText=function(t,e,r){var n=this.codeMirror;n.replaceRange("",n.posFromIndex(t),n.posFromIndex(e),r)},a.prototype.insertEntityAtCursor=function(t,e,r){var n=this.codeMirror,i=n.indexFromPos(n.getCursor("head"));this.insertEntityAt(i,t,e,r)},a.prototype.insertEntityAt=function(e,r,n,i){this.codeMirror;this.insertEntity_(e,new t.Entity(r,n),i)},a.prototype.insertEntity_=function(t,e,r){this.replaceText(t,null,u,e.toAttributes(),r)},a.prototype.getAttributeSpans=function(t,e){for(var n=[],i=this.annotationList_.getAnnotatedSpansForSpan(new r(t,e-t)),o=0;o<i.length;o++)n.push({length:i[o].length,attributes:i[o].annotation.attributes});return n},a.prototype.end=function(){var t=this.codeMirror.lineCount()-1;return this.codeMirror.indexFromPos({line:t,ch:this.codeMirror.getLine(t).length})},a.prototype.getRange=function(t,e){var r=this.codeMirror.posFromIndex(t),n=this.codeMirror.posFromIndex(e);return this.codeMirror.getRange(r,n)},a.prototype.initAnnotationList_=function(){var t=this.end();0!==t&&this.annotationList_.insertAnnotatedSpan(new r(0,t),new g)},a.prototype.onAnnotationsChanged_=function(t,e){var r,n={};this.tryToUpdateEntitiesInPlace(t,e);for(var o=0;o<t.length;o++){var s=t[o].annotation.attributes;i.LINE_SENTINEL in s&&(n[this.codeMirror.posFromIndex(t[o].pos).line]=!0),(r=t[o].getAttachedObject())&&r.clear()}for(o=0;o<e.length;o++){var a=e[o].annotation,h=i.LINE_SENTINEL in a.attributes,u=i.ENTITY_SENTINEL in a.attributes,c=this.codeMirror.posFromIndex(e[o].pos);if(h)n[c.line]=!0;else if(u)this.markEntity_(e[o]);else{var l=this.getClassNameForAttributes_(a.attributes);if(""!==l){var p=this.codeMirror.posFromIndex(e[o].pos+e[o].length);r=this.codeMirror.markText(c,p,{className:l}),e[o].attachObject(r)}}}for(var d in n)this.dirtyLines_.push(this.codeMirror.getLineHandle(Number(d))),this.queueLineMarking_()},a.prototype.tryToUpdateEntitiesInPlace=function(t,e){for(var r=t.length;r--;)for(var n=t[r],i=e.length;i--;){var o=e[i];if(n.pos==o.pos&&n.length==o.length&&n.annotation.attributes.ent&&n.annotation.attributes.ent==o.annotation.attributes.ent){var s=o.annotation.attributes.ent;if(this.entityManager_.entitySupportsUpdate(s)){t.splice(r,1),e.splice(i,1);var a=n.getAttachedObject();a.update(o.annotation.attributes),o.attachObject(a)}}}},a.prototype.queueLineMarking_=function(){if(null==this.lineMarkTimeout_){var t=this;this.lineMarkTimeout_=setTimeout(function(){t.lineMarkTimeout_=null;for(var e=[],r=0;r<t.dirtyLines_.length;r++){var n=t.codeMirror.getLineNumber(t.dirtyLines_[r]);e.push(Number(n))}t.dirtyLines_=[],e.sort(function(t,e){return t-e});var i=-1;for(r=0;r<e.length;r++){var o=e[r];o>i&&(i=t.markLineSentinelCharactersForChangedLines_(o,o))}},0)}},a.prototype.addStyleWithCSS_=function(t){var e=document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css",r.styleSheet?r.styleSheet.cssText=t:r.appendChild(document.createTextNode(t)),e.appendChild(r)},a.prototype.getClassNameForAttributes_=function(e){var r="";for(var n in e){var a=e[n];if(n===i.LINE_SENTINEL)t.utils.assert(!0===a,"LINE_SENTINEL attribute should be true if it exists.");else{var h=(this.options_.cssPrefix||"cmrt-")+n;if(!0!==a){n===i.FONT_SIZE&&"string"!=typeof a&&(a+="px");var u=a.toString().toLowerCase().replace(/[^a-z0-9-_]/g,"-");if(h+="-"+u,o[n]&&(s[n]||(s[n]={}),!s[n][u])){s[n][u]=!0;var c=o[n],l="function"==typeof c?c(a):c+": "+a,p=n==i.LINE_INDENT?"pre."+h:"."+h;this.addStyleWithCSS_(p+" { "+l+" }")}}r=r+" "+h}}return r},a.prototype.markEntity_=function(e){for(var r=e.annotation.attributes,n=t.Entity.fromAttributes(r),i=this.codeMirror,o=this,s=[],a=0;a<e.length;a++){var h=i.posFromIndex(e.pos+a),u=i.posFromIndex(e.pos+a+1),c={collapsed:!0,atomic:!0,inclusiveLeft:!1,inclusiveRight:!1},l=this.createEntityHandle_(n,e.pos),p=this.entityManager_.renderToElement(n,l);p&&(c.replacedWith=p);var d=i.markText(h,u,c);s.push(d),l.setMarker(d)}e.attachObject({clear:function(){for(var t=0;t<s.length;t++)s[t].clear()},update:function(e){for(var r=t.Entity.fromAttributes(e),n=0;n<s.length;n++)o.entityManager_.updateElement(r,s[n].replacedWith)}}),this.queueRefresh_()},a.prototype.queueRefresh_=function(){var t=this;this.refreshTimer_||(this.refreshTimer_=setTimeout(function(){t.codeMirror.refresh(),t.refreshTimer_=null},0))},a.prototype.createEntityHandle_=function(e,r){var n=null,i=this;function o(){if(n){var t=n.find();return t?i.codeMirror.indexFromPos(t.from):null}return r}return{find:o,remove:function(){var t=o();null!=t&&(i.codeMirror.focus(),i.removeText(t,t+1))},replace:function(r){var n=t.AttributeConstants.ENTITY_SENTINEL,s=n+"_",a=o();i.updateTextAttributes(a,a+1,function(t){for(var i in t)delete t[i];for(var o in t[n]=e.type,r)t[s+o]=r[o]})},setMarker:function(t){n=t}}},a.prototype.lineClassRemover_=function(t){var e=this.codeMirror,r=e.getLineHandle(t);return{clear:function(){e.removeLineClass(r,"text",".*")}}},a.prototype.emptySelection_=function(){var t=this.codeMirror.getCursor("start"),e=this.codeMirror.getCursor("end");return t.line===e.line&&t.ch===e.ch},a.prototype.onCodeMirrorBeforeChange_=function(t,e){if("+input"===e.origin||"paste"===e.origin){for(var r=[],n=0;n<e.text.length;n++){var i=e.text[n];i=i.replace(new RegExp("["+h+u+"]","g"),""),r.push(i)}e.update(e.from,e.to,r)}},a.prototype.onCodeMirrorCopyCut_=function(t,e){var r=this.codeMirror.firepad;if(r.selectionHasAttributes()){var n=r.getHtmlFromSelection();if(n){if(!this.firepadStyleWrapper){var i=window.getComputedStyle(this.codeMirror.getWrapperElement());this.firepadStyleWrapper="font-family:"+i.getPropertyValue("font-family")+";font-size:"+i.getPropertyValue("font-size")+";background-color:"+i.getPropertyValue("background-color")+";color:"+i.getPropertyValue("color")+";text-align:"+i.getPropertyValue("text-align")+";"}n='<span style="'+this.firepadStyleWrapper+'">'+n+"</span>";var o=/AppleWebKit/.test(navigator.userAgent)&&/Mobile\/\w+/.test(navigator.userAgent);e.clipboardData&&!o&&("cut"==e.type&&t.replaceSelection("",null,"cut"),e.preventDefault(),e.clipboardData.clearData(),e.clipboardData.setData("text/html",n))}}},a.prototype.onCodeMirrorPaste_=function(t,e){var r=e.clipboardData?e.clipboardData.getData("text/html"):null;r&&(t.replaceSelection(""),this.codeMirror.firepad.insertHtmlAtCursor(r),e.preventDefault())},a.prototype.onCodeMirrorChange_=function(t,e){if("object"==typeof e.from){for(var n=[];e;)n.push(e),e=e.next;e=n}for(var i=this.convertCoordinateSystemForChanges_(e),o=[],s=0;s<i.length;s++){var a,h=i[s],u=h.start,c=(h.end,h.text),l=h.removed,p=h.origin;if(l.length>0){for(var d=this.annotationList_.getAnnotatedSpansForSpan(new r(u,l.length)),f=0,m=0;m<d.length;m++){var y=d[m];o.push({start:u,end:u+y.length,removedAttributes:y.annotation.attributes,removed:l.substr(f,y.length),attributes:{},text:"",origin:h.origin}),f+=y.length}this.annotationList_.removeSpan(new r(u,l.length))}if(c.length>0)"+input"===h.origin||"paste"===h.origin?a=this.currentAttributes_||{}:p in this.outstandingChanges_?(a=this.outstandingChanges_[p].attributes,p=this.outstandingChanges_[p].origOrigin,delete this.outstandingChanges_[p]):a={},this.annotationList_.insertAnnotatedSpan(new r(u,c.length),new g(a)),o.push({start:u,end:u,removedAttributes:{},removed:"",text:c,attributes:a,origin:p})}this.markLineSentinelCharactersForChanges_(e),o.length>0&&this.trigger("change",this,o),this.cleanup()},a.prototype.cleanup=function(){setTimeout(()=>{let t=this.codeMirror.lineCount();t>this.options_.maxLineCount&&(this.codeMirror.replaceRange("",{line:this.options_.maxLineCount-1,ch:0},{line:t-1,ch:0}),t=this.codeMirror.lineCount()),t=this.codeMirror.lineCount();const e=this.options_.maxLineCount-t;this.codeMirror.firepad.toolbar.updateLinesRemaining(e)},10)},a.prototype.convertCoordinateSystemForChanges_=function(t){var e=this,r=function(t){return e.codeMirror.indexFromPos(t)};function n(t,e){return function(r){return p(r,e.from)?t(r):p(e.to,r)?t({line:r.line+e.text.length-1-(e.to.line-e.from.line),ch:e.to.line<r.line?r.ch:e.text.length<=1?r.ch-(e.to.ch-e.from.ch)+d(e.text):r.ch-e.to.ch+(n=e.text,n[n.length-1]).length})+d(e.removed)-d(e.text):e.from.line===r.line?t(e.from)+r.ch-e.from.ch:t(e.from)+d(e.removed.slice(0,r.line-e.from.line))+1+r.ch;var n}}for(var i=[],o=t.length-1;o>=0;o--){var s=t[o],a=(r=n(r,s))(s.from),h=s.removed.join("\n"),u=s.text.join("\n");i.unshift({start:a,end:a+h.length,removed:h,text:u,origin:s.origin})}return i},a.prototype.markLineSentinelCharactersForChanges_=function(t){for(var e=Number.MAX_VALUE,r=-1,n=0;n<t.length;n++){var i=t[n],o=i.from.line;i.from.ch;(i.removed.length>1||i.removed[0].indexOf(h)>=0)&&(e=Math.min(e,o),r=Math.max(r,o)),i.text.length>1?(e=Math.min(e,o),r=Math.max(r,o+i.text.length-1)):i.text[0].indexOf(h)>=0&&(e=Math.min(e,o),r=Math.max(r,o))}r=Math.min(r,this.codeMirror.lineCount()-1),this.markLineSentinelCharactersForChangedLines_(e,r)},a.prototype.markLineSentinelCharactersForChangedLines_=function(t,e){if(t<Number.MAX_VALUE)for(;t>0&&this.lineIsListItemOrIndented_(t-1);)t--;if(e>-1)for(var r=this.codeMirror.lineCount();e+1<r&&this.lineIsListItemOrIndented_(e+1);)e++;for(var n=[],i=this.codeMirror,o=t;o<=e;o++){var s=i.getLine(o),a=i.getLineHandle(o);if(i.removeLineClass(a,"text",".*"),s.length>0)for(var u=s.indexOf(h);u>=0;){for(var c=u;u<s.length&&s[u]===h;){for(var l=i.findMarksAt({line:o,ch:u}),p=0;p<l.length;p++)l[p].isForLineSentinel&&l[p].clear();u++}this.markLineSentinelCharacters_(o,c,u,n),u=s.indexOf(h,u)}else n=[]}return e},a.prototype.markLineSentinelCharacters_=function(t,e,r,n){var o;if(this.annotationList_.getAnnotatedSpansForPos(t).length>1){var s=this.annotationList_.getAnnotatedSpansForPos(t)[1].annotation.attributes;o=this.getClassNameForAttributes_(s)}var a=this.codeMirror,h=null,u=null,c=function(){var t=u.find();return t?t.from.line:null};if(0===e){var l=this.getLineAttributes_(t),p=l[i.LIST_TYPE],d=l[i.LINE_INDENT]||0;for(p&&0===d&&(d=1);d>=n.length;)n.push(1);"o"===p?(h=this.makeOrderedListElement_(n[d],o),n[d]++):"u"===p?(h=this.makeUnorderedListElement_(o),n[d]=1):"t"===p?(h=this.makeTodoListElement_(!1,c),n[d]=1):"tc"===p&&(h=this.makeTodoListElement_(!0,c),n[d]=1);var f=this.getClassNameForAttributes_(l);""!==f&&this.codeMirror.addLineClass(t,"text",f),n=n.slice(0,d+1)}var g={inclusiveLeft:!0,collapsed:!0};h&&(g.replacedWith=h),(u=a.markText({line:t,ch:e},{line:t,ch:r},g)).isForLineSentinel=!0},a.prototype.makeOrderedListElement_=function(t,e){var r=e||this.getClassNameForAttributes_(this.currentAttributes_);return n.elt("div",t+".",{class:"firepad-list-left "+r})},a.prototype.makeUnorderedListElement_=function(t){var e=t||this.getClassNameForAttributes_(this.currentAttributes_);return n.elt("div","•",{class:"firepad-list-left "+e})},a.prototype.toggleTodo=function(t){var e,r=i.LIST_TYPE,n=this.getCurrentLineAttributes_();r in n&&("t"===n[r]||"tc"===n[r])?"t"===n[r]?e="tc":"tc"===n[r]&&(e=!!t&&"t"):e="t",this.setLineAttribute(r,e)},a.prototype.makeTodoListElement_=function(t,e){var r={type:"checkbox",class:"firepad-todo-left"};t&&(r.checked=!0);var i=n.elt("input",!1,r),o=this;return n.on(i,"click",n.stopEventAnd(function(t){o.codeMirror.setCursor({line:e(),ch:1}),o.toggleTodo(!0)})),i},a.prototype.lineIsListItemOrIndented_=function(t){var e=this.getLineAttributes_(t);return!1!==(e[i.LIST_TYPE]||!1)||0!==(e[i.LINE_INDENT]||0)},a.prototype.onCursorActivity_=function(){var t=!this.doNotUpdateCurrentAttributesOnNextCursorActivity;if(this.doNotUpdateCurrentAttributesOnNextCursorActivity=!1,t){var e=this;setTimeout(function(){e.updateCurrentAttributes_()},1)}},a.prototype.getCurrentAttributes_=function(){return this.currentAttributes_||this.updateCurrentAttributes_(),this.currentAttributes_},a.prototype.updateCurrentAttributes_=function(){var e,r,n=this.codeMirror,o=n.indexFromPos(n.getCursor("anchor")),s=n.indexFromPos(n.getCursor("head")),a=s,u="";if(o>s){for(;a<this.end()&&("\n"===(u=this.getRange(a,a+1))||u===h);)a++;a<this.end()&&a++}else{for(;a>0&&("\n"===(u=this.getRange(a-1,a))||u===h);)a--;"\n"==c&&a++}var c=this.getRange(s,s+1),l="\n"===c||""===c,p=this.getRange(s-1,s)==h;o==s&&(0===s||p&&!l)?r=(e=this.annotationList_.getAnnotatedSpansForPos(s)).length<2:(r=!0,e=this.annotationList_.getAnnotatedSpansForPos(a)),this.currentAttributes_={};var d={};for(var f in r&&e.length>0&&!(i.LINE_SENTINEL in e[0].annotation.attributes)?d=e[0].annotation.attributes:!r&&e.length>1&&(t.utils.assert(!(i.LINE_SENTINEL in e[1].annotation.attributes),"Cursor can't be between two line sentinel characters."),d=e[1].annotation.attributes),d)"l"!==f&&"lt"!==f&&"li"!==f&&0!==f.indexOf(i.ENTITY_SENTINEL)&&(this.currentAttributes_[f]=d[f]);this.updateToolbarButnsState_()},a.prototype.updateToolbarButnsState_=function(){if(this.codeMirror&&this.codeMirror.firepad&&this.codeMirror.firepad.toolbar){var t=this.codeMirror.firepad.toolbar,e=this.currentAttributes_;t.boldBtnElem||(t.boldBtnElem=t.element_.getElementsByClassName("firepad-tb-bold")[0].parentElement,t.italicBtnElem=t.element_.getElementsByClassName("firepad-tb-italic")[0].parentElement,t.underlineBtnElem=t.element_.getElementsByClassName("firepad-tb-underline")[0].parentElement,t.strikeBtnElem=t.element_.getElementsByClassName("firepad-tb-strikethrough")[0].parentElement),t.updateToolbarButnsStateTimeout&&clearTimeout(t.updateToolbarButnsStateTimeout),t.updateToolbarButnsStateTimeout=setTimeout(function(){f(t.boldBtnElem,"firepad-btn-highlight",!0===e.b),f(t.italicBtnElem,"firepad-btn-highlight",!0===e.i),f(t.underlineBtnElem,"firepad-btn-highlight",!0===e.u),f(t.strikeBtnElem,"firepad-btn-highlight",!0===e.s)},100)}},a.prototype.getCurrentLineAttributes_=function(){var t=this.codeMirror,e=t.getCursor("anchor"),r=t.getCursor("head"),n=r.line;return 0===r.ch&&e.line<r.line&&n--,this.getLineAttributes_(n)},a.prototype.getLineAttributes_=function(e){var n={},i=this.codeMirror.getLine(e);if(i.length>0&&i[0]===h){var o=this.codeMirror.indexFromPos({line:e,ch:0}),s=this.annotationList_.getAnnotatedSpansForSpan(new r(o,1));for(var a in t.utils.assert(1===s.length),s[0].annotation.attributes)n[a]=s[0].annotation.attributes[a]}return n},a.prototype.clearAnnotations_=function(){this.annotationList_.updateSpan(new r(0,this.end()),function(t,e){return new g({})})},a.prototype.newline=function(){var t=this.codeMirror,e=this;if(this.emptySelection_()){var r=t.getCursor("head").line,n=this.getLineAttributes_(r),o=n[i.LIST_TYPE];o&&1===t.getLine(r).length?this.updateLineAttributes(r,r,function(t){delete t[i.LIST_TYPE],delete t[i.LINE_INDENT]}):(t.replaceSelection("\n","end","+input"),this.updateLineAttributes(r+1,r+1,function(t){for(var s in n)t[s]=n[s];"tc"===o&&(t[i.LIST_TYPE]="t"),e.trigger("newLine",{line:r+1,attr:t})}))}else t.replaceSelection("\n","end","+input")},a.prototype.deleteLeft=function(){var t=this.codeMirror,e=t.getCursor("head"),r=this.getLineAttributes_(e.line),n=r[i.LIST_TYPE],o=r[i.LINE_INDENT],s=t.getDoc().getValue(),a=this.emptySelection_()&&1===e.ch;if(a&&n)this.updateLineAttributes(e.line,e.line,function(t){delete t[i.LIST_TYPE],delete t[i.LINE_INDENT]});else{if(0===s.length||1===s.length&&57344===s.charCodeAt(0))return;if(a&&o&&o>0)this.unindent();else{t.getRange({line:e.line,ch:e.ch-1},e);this.updateCurrentAttributes_(),this.doNotUpdateCurrentAttributesOnNextCursorActivity=!0,t.deleteH(-1,"char")}}},a.prototype.deleteRight=function(){var t=this.codeMirror,e=t.getCursor("head"),r=t.getLine(e.line),n=this.areLineSentinelCharacters_(r),i=e.line+1<t.lineCount()?t.getLine(e.line+1):"";this.emptySelection_()&&n&&i[0]===h?(t.replaceRange("",{line:e.line,ch:0},{line:e.line+1,ch:0},"+input"),t.setCursor({line:e.line,ch:0})):t.deleteH(1,"char")},a.prototype.indent=function(){this.updateLineAttributesForSelection(function(t){var e=t[i.LINE_INDENT],r=t[i.LIST_TYPE];e?t[i.LINE_INDENT]++:t[i.LINE_INDENT]=r?2:1})},a.prototype.unindent=function(){this.updateLineAttributesForSelection(function(t){var e=t[i.LINE_INDENT];e&&e>1?t[i.LINE_INDENT]=e-1:(delete t[i.LIST_TYPE],delete t[i.LINE_INDENT])})},a.prototype.getText=function(){return this.codeMirror.getValue().replace(new RegExp(h,"g"),"")},a.prototype.areLineSentinelCharacters_=function(t){for(var e=0;e<t.length;e++)if(t[e]!==h)return!1;return!0},g.prototype.equals=function(t){if(!(t instanceof g))return!1;var e;for(e in this.attributes)if(t.attributes[e]!==this.attributes[e])return!1;for(e in t.attributes)if(t.attributes[e]!==this.attributes[e])return!1;return!0},a}(),(t=t||{}).RichTextCodeMirrorAdapter=function(){"use strict";var e=t.TextOperation,r=t.WrappedOperation,n=t.Cursor;function i(t){this.rtcm=t,this.cm=t.codeMirror,h(this,"onChange"),h(this,"onAttributesChange"),h(this,"onCursorActivity"),h(this,"onFocus"),h(this,"onBlur"),this.rtcm.on("change",this.onChange),this.rtcm.on("attributesChange",this.onAttributesChange),this.cm.on("cursorActivity",this.onCursorActivity),this.cm.on("focus",this.onFocus),this.cm.on("blur",this.onBlur)}function o(t,e){return t.line<e.line?-1:t.line>e.line?1:t.ch<e.ch?-1:t.ch>e.ch?1:0}function s(t){var e=t.lineCount()-1;return t.indexFromPos({line:e,ch:t.getLine(e).length})}function a(t,e){if(!t)throw new Error(e||"assertion error")}function h(t,e){var r=t[e];t[e]=function(){r.apply(t,arguments)}}function u(t){for(var e in t)return!1;return!0}function c(t,e){if("string"!=typeof t)throw new TypeError("Expected a string");3===(t=t.replace(/^#/,"")).length&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);var r,n=parseInt(t,16),i=[n>>16,n>>8&255,255&n],o="rgb";return null!==(r=e)&&void 0!==r&&(o="rgba",i.push(e)),o+"("+i.join(",")+")"}return i.prototype.detach=function(){this.rtcm.off("change",this.onChange),this.rtcm.off("attributesChange",this.onAttributesChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},i.operationFromCodeMirrorChanges=function(t,r){for(var n=s(r),i=(new e).retain(n),o=(new e).retain(n),a=t.length-1;a>=0;a--){var h=t[a],u=h.start,c=n-u-h.text.length;i=(new e).retain(u).delete(h.removed.length).insert(h.text,h.attributes).retain(c).compose(i),o=o.compose((new e).retain(u).delete(h.text.length).insert(h.removed,h.removedAttributes).retain(c)),n+=h.removed.length-h.text.length}return[i,o]},i.operationFromAttributesChanges=function(t,r){for(var n=s(r),i=new e,o=new e,h=0,u=0;u<t.length;u++){var c=t[u],l=c.start-h;a(l>=0),i.retain(l),o.retain(l);var p=c.end-c.start;i.retain(p,c.attributes),o.retain(p,c.attributesInverse),h=c.start+p}return i.retain(n-h),o.retain(n-h),[i,o]},i.prototype.registerCallbacks=function(t){this.callbacks=t},i.prototype.onChange=function(t,e){if("RTCMADAPTER"!==e[0].origin){var r=i.operationFromCodeMirrorChanges(e,this.cm);this.trigger("change",r[0],r[1])}},i.prototype.onAttributesChange=function(t,e){if("RTCMADAPTER"!==e[0].origin){var r=i.operationFromAttributesChanges(e,this.cm);this.trigger("change",r[0],r[1])}},i.prototype.onCursorActivity=function(){var t=this;setTimeout(function(){t.trigger("cursorActivity")},1)},i.prototype.onFocus=function(){this.trigger("focus")},i.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},i.prototype.getValue=function(){return this.cm.getValue()},i.prototype.getCursor=function(){var t,e=this.cm,r=e.getCursor(),i=e.indexFromPos(r);if(e.somethingSelected()){var s=e.getCursor(!0),a=0===o(r,s)?e.getCursor(!1):s;t=e.indexFromPos(a)}else t=i;return new n(i,t)},i.prototype.setCursor=function(t){this.cm.setSelection(this.cm.posFromIndex(t.position),this.cm.posFromIndex(t.selectionEnd))},i.prototype.addStyleRule=function(t){if("undefined"!=typeof document&&null!==document){if(!this.addedStyleRules){this.addedStyleRules={};var e=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(e),this.addedStyleSheet=e.sheet}if(!this.addedStyleRules[t])return this.addedStyleRules[t]=!0,this.addedStyleSheet.insertRule(t,0)}},i.prototype.setOtherCursor=function(t,e,r,n){var i=this.cm.posFromIndex(t.position);if("string"==typeof e&&e.match(/^#[a-fA-F0-9]{3,6}$/)){var o=this.rtcm.end();if("object"==typeof t&&"number"==typeof t.position&&"number"==typeof t.selectionEnd&&!(t.position<0||t.position>o||t.selectionEnd<0||t.selectionEnd>o)){if(t.position===t.selectionEnd){var s=this.cm.cursorCoords(i),a=document.createElement("div");a.className="other-client",a.style.display="inline",a.style.borderLeftWidth="2px",a.style.borderLeftStyle="solid",a.style.borderLeftColor=e,a.style.marginLeft=a.style.marginRight="-1px",a.style.height=.9*(s.bottom-s.top)+"px",a.setAttribute("data-clientid",r),a.style.zIndex=0;var h=document.createElement("span");return h.innerHTML=n,h.className="firepad-cursor-label",h.style.color=e,a.appendChild(h),this.cm.setBookmark(i,{widget:a,insertLeft:!0})}var u,l,p="selection-"+e.replace("#",""),d="."+p+" { background: "+c(e)+";\n background: "+c(e,.4)+";}";return this.addStyleRule(d),t.selectionEnd>t.position?(u=i,l=this.cm.posFromIndex(t.selectionEnd)):(u=this.cm.posFromIndex(t.selectionEnd),l=i),this.cm.markText(u,l,{className:p})}}},i.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),r=this.callbacks&&this.callbacks[t];r&&r.apply(this,e)},i.prototype.applyOperation=function(t){t.ops.length>10&&this.rtcm.codeMirror.getWrapperElement().setAttribute("style","display: none");for(var e=t.ops,r=0,n=0,i=e.length;n<i;n++){var o=e[n];o.isRetain()?(u(o.attributes)||this.rtcm.updateTextAttributes(r,r+o.chars,function(t){for(var e in o.attributes)!1===o.attributes[e]?delete t[e]:t[e]=o.attributes[e]},"RTCMADAPTER",!0),r+=o.chars):o.isInsert()?(this.rtcm.insertText(r,o.text,o.attributes,"RTCMADAPTER"),r+=o.text.length):o.isDelete()&&this.rtcm.removeText(r,r+o.chars,"RTCMADAPTER")}t.ops.length>10&&(this.rtcm.codeMirror.getWrapperElement().setAttribute("style",""),this.rtcm.codeMirror.refresh())},i.prototype.registerUndo=function(t){this.cm.undo=t},i.prototype.registerRedo=function(t){this.cm.redo=t},i.prototype.invertOperation=function(t){for(var n,i,o=0,s=this.rtcm.codeMirror,a=new e,h=0;h<t.wrapped.ops.length;h++){var c=t.wrapped.ops[h];if(c.isRetain())if(u(c.attributes))a.retain(c.chars),o+=c.chars;else for(n=this.rtcm.getAttributeSpans(o,o+c.chars),i=0;i<n.length;i++){var l={};for(var p in c.attributes){var d=c.attributes[p],f=n[i].attributes[p];!1===d?f&&(l[p]=f):d!==f&&(l[p]=f||!1)}a.retain(n[i].length,l),o+=n[i].length}else if(c.isInsert())a.delete(c.text.length);else if(c.isDelete()){var g=s.getRange(s.posFromIndex(o),s.posFromIndex(o+c.chars));n=this.rtcm.getAttributeSpans(o,o+c.chars);var m=0;for(i=0;i<n.length;i++)a.insert(g.substr(m,n[i].length),n[i].attributes),m+=n[i].length;o+=c.chars}}return new r(a,t.meta.invert())},i}(),(t=t||{}).Formatting=function(){var e=t.AttributeConstants;function r(t){if(!(this instanceof r))return new r(t);this.attributes=t||{}}return r.prototype.cloneWithNewAttribute_=function(t,e){var n={};for(var i in this.attributes)n[i]=this.attributes[i];return!1===e?delete n[t]:n[t]=e,new r(n)},r.prototype.bold=function(t){return this.cloneWithNewAttribute_(e.BOLD,t)},r.prototype.italic=function(t){return this.cloneWithNewAttribute_(e.ITALIC,t)},r.prototype.underline=function(t){return this.cloneWithNewAttribute_(e.UNDERLINE,t)},r.prototype.strike=function(t){return this.cloneWithNewAttribute_(e.STRIKE,t)},r.prototype.font=function(t){return this.cloneWithNewAttribute_(e.FONT,t)},r.prototype.fontSize=function(t){return this.cloneWithNewAttribute_(e.FONT_SIZE,t)},r.prototype.color=function(t){return this.cloneWithNewAttribute_(e.COLOR,t)},r.prototype.backgroundColor=function(t){return this.cloneWithNewAttribute_(e.BACKGROUND_COLOR,t)},r}(),(t=t||{}).Text=function(){return function e(r,n){if(!(this instanceof e))return new e(r,n);this.text=r,this.formatting=n||t.Formatting()}}(),(t=t||{}).LineFormatting=function(){var e=t.AttributeConstants;function r(t){if(!(this instanceof r))return new r(t);this.attributes=t||{},this.attributes[e.LINE_SENTINEL]=!0}return r.LIST_TYPE={NONE:!1,ORDERED:"o",UNORDERED:"u",TODO:"t",TODOCHECKED:"tc"},r.prototype.cloneWithNewAttribute_=function(t,e){var n={};for(var i in this.attributes)n[i]=this.attributes[i];return!1===e?delete n[t]:n[t]=e,new r(n)},r.prototype.indent=function(t){return this.cloneWithNewAttribute_(e.LINE_INDENT,t)},r.prototype.align=function(t){return this.cloneWithNewAttribute_(e.LINE_ALIGN,t)},r.prototype.listItem=function(r){return t.utils.assert(!1===r||"u"===r||"o"===r||"t"===r||"tc"===r),this.cloneWithNewAttribute_(e.LIST_TYPE,r)},r.prototype.getIndent=function(){return this.attributes[e.LINE_INDENT]||0},r.prototype.getAlign=function(){return this.attributes[e.LINE_ALIGN]||0},r.prototype.getListItem=function(){return this.attributes[e.LIST_TYPE]||!1},r}(),(t=t||{}).Line=function(){return function e(r,n){if(!(this instanceof e))return new e(r,n);"[object Array]"!==Object.prototype.toString.call(r)&&(r=void 0===r?[]:[r]),this.textPieces=r,this.formatting=n||t.LineFormatting()}}(),(t=t||{}).ParseHtml=function(){var e,r,n=t.LineFormatting.LIST_TYPE;function i(e,r,i){this.listType=e||n.UNORDERED,this.lineFormatting=r||t.LineFormatting(),this.textFormatting=i||t.Formatting()}function o(){this.lines=[],this.currentLine=[],this.currentLineListItemType=null}i.prototype.withTextFormatting=function(t){return new i(this.listType,this.lineFormatting,t)},i.prototype.withLineFormatting=function(t){return new i(this.listType,t,this.textFormatting)},i.prototype.withListType=function(t){return new i(t,this.lineFormatting,this.textFormatting)},i.prototype.withIncreasedIndent=function(){var t=this.lineFormatting.indent(this.lineFormatting.getIndent()+1);return new i(this.listType,t,this.textFormatting)},i.prototype.withAlign=function(t){var e=this.lineFormatting.align(t);return new i(this.listType,e,this.textFormatting)},o.prototype.newlineIfNonEmpty=function(t){this.cleanLine_(!0),this.currentLine.length>0&&this.newline(t)},o.prototype.newlineIfNonEmptyOrListItem=function(t){this.cleanLine_(!0),(this.currentLine.length>0||null!==this.currentLineListItemType)&&this.newline(t)},o.prototype.newline=function(e){this.cleanLine_();var r=e.lineFormatting;null!==this.currentLineListItemType&&(r=r.listItem(this.currentLineListItemType),this.currentLineListItemType=null),this.lines.push(t.Line(this.currentLine,r)),this.currentLine=[]},o.prototype.makeListItem=function(t){this.currentLineListItemType=t},o.prototype.cleanLine_=function(t){if(this.currentLine.length>0){var e=this.currentLine.length-1;if(this.currentLine[0].text=this.currentLine[0].text.replace(/^ +/,""),this.currentLine[e].text=this.currentLine[e].text.replace(/ +$/g,""),!t)for(var r=0;r<this.currentLine.length;r++)this.currentLine[r].text=this.currentLine[r].text.replace(/\u00a0/g," ")}1===this.currentLine.length&&""===this.currentLine[0].text&&(this.currentLine=[])};var s=s||{ELEMENT_NODE:1,TEXT_NODE:3};function a(i,o,a){if(i.nodeType===s.ELEMENT_NODE){var c=e.fromElement(i);if(c)return void a.currentLine.push(new t.Text(t.sentinelConstants.ENTITY_SENTINEL_CHARACTER,new t.Formatting(c.toAttributes())))}switch(i.nodeType){case s.TEXT_NODE:var l=i.nodeValue.replace(/ /g," ");a.currentLine.push(t.Text(l,o.textFormatting));break;case s.ELEMENT_NODE:switch(o=function(e,n){if(!this.firepadDefaultStyles){var i=window.getComputedStyle(r.getWrapperElement());firepadDefaultStyles={fontFamily:i.getPropertyValue("font-family"),fontSize:i.getPropertyValue("font-size"),backgroundColor:i.getPropertyValue("background-color"),color:i.getPropertyValue("color"),textAlign:i.getPropertyValue("text-align")}}for(var o=e.textFormatting,s=e.lineFormatting,a=n.split(";"),h=0;h<a.length;h++){var c=a[h].split(":");if(2===c.length){var l=t.utils.trim(c[0]).toLowerCase(),p=t.utils.trim(c[1]).toLowerCase();switch(l){case"text-decoration":var d=p.indexOf("underline")>=0,f=p.indexOf("line-through")>=0;o=o.underline(d).strike(f);break;case"font-weight":var g="bold"===p||parseInt(p)>=600;o=o.bold(g);break;case"font-style":var m="italic"===p||"oblique"===p;o=o.italic(m);break;case"color":if(u(p,this.firepadDefaultStyles.color))break;o=o.color(p);break;case"background-color":if(u(p,this.firepadDefaultStyles.backgroundColor))break;o=o.backgroundColor(p);break;case"text-align":if(u(p,this.firepadDefaultStyles.textAlign))break;s=s.align(p);break;case"font-size":if(u(p,this.firepadDefaultStyles.fontSize))break;var y=null;t.utils.stringEndsWith(p,["px","pt","%","em","xx-small","x-small","small","medium","large","x-large","xx-large","smaller","larger"])?y=p:parseInt(p)&&(y=parseInt(p)+"px"),y&&(o=o.fontSize(y));break;case"font-family":if(u(p,this.firepadDefaultStyles.fontFamily))break;var v=t.utils.trim(p.split(",")[0]);v=(v=v.replace(/['"]/g,"")).replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()}),o=o.font(v)}}}return e.withLineFormatting(s).withTextFormatting(o)}(o,i.getAttribute("style")||""),i.nodeName.toLowerCase()){case"div":case"h1":case"h2":case"h3":case"p":a.newlineIfNonEmpty(o),h(i,o,a),a.newlineIfNonEmpty(o);break;case"center":o=o.withAlign("center"),a.newlineIfNonEmpty(o),h(i,o.withAlign("center"),a),a.newlineIfNonEmpty(o);break;case"b":case"strong":h(i,o.withTextFormatting(o.textFormatting.bold(!0)),a);break;case"u":h(i,o.withTextFormatting(o.textFormatting.underline(!0)),a);break;case"i":case"em":h(i,o.withTextFormatting(o.textFormatting.italic(!0)),a);break;case"s":h(i,o.withTextFormatting(o.textFormatting.strike(!0)),a);break;case"font":var p=i.getAttribute("face"),d=i.getAttribute("color"),f=parseInt(i.getAttribute("size"));p&&(o=o.withTextFormatting(o.textFormatting.font(p))),d&&(o=o.withTextFormatting(o.textFormatting.color(d))),f&&(o=o.withTextFormatting(o.textFormatting.fontSize(f))),h(i,o,a);break;case"br":a.newline(o);break;case"ul":a.newlineIfNonEmptyOrListItem(o);var g="firepad-todo"===i.getAttribute("class")?n.TODO:n.UNORDERED;h(i,o.withListType(g).withIncreasedIndent(),a),a.newlineIfNonEmpty(o);break;case"ol":a.newlineIfNonEmptyOrListItem(o),h(i,o.withListType(n.ORDERED).withIncreasedIndent(),a),a.newlineIfNonEmpty(o);break;case"li":!function(t,e,r){r.newlineIfNonEmptyOrListItem(e);var i="firepad-checked"===t.getAttribute("class")?n.TODOCHECKED:e.listType;r.makeListItem(i);var o=r.currentLine;h(t,e,r),(o===r.currentLine||r.currentLine.length>0)&&r.newline(e)}(i,o,a);break;case"style":break;default:h(i,o,a)}}}function h(t,e,r){if(t.hasChildNodes())for(var n=0;n<t.childNodes.length;n++)a(t.childNodes[n],e,r)}function u(t,e){return(t=(t=(t=t.toLowerCase()).split(" ").join("")).lastIndexOf(";")==t.length-1?t.substring(0,t.length-1):t)==(e=(e=(e=e.toLowerCase()).split(" ").join("")).lastIndexOf(";")==e.length-1?e.substring(0,e.length-1):e)}return function(n,s,h){n=(n=n.replace(/(\r\n|\n|\r)?<html>(\r\n|\n|\r)?<body>(\r\n|\n|\r)?/,"")).replace(/(\r\n|\n|\r)?<\/body>(\r\n|\n|\r)?<\/html>(\r\n|\n|\r)?/,"");var u=(t.document||document).createElement("div");u.innerHTML=n,e=s,r=h;var c=new o;return a(u,new i,c),c.lines}}(),(t=t||{}).SerializeHtml=function(){var e=t.utils,r=t.AttributeConstants,n=t.LineFormatting.LIST_TYPE,i='<style>ul.firepad-todo { list-style: none; margin-left: 0; padding-left: 0; } ul.firepad-todo > li { padding-left: 1em; text-indent: -1em; } ul.firepad-todo > li:before { content: "\\2610"; padding-right: 5px; } ul.firepad-todo > li.firepad-checked:before { content: "\\2611"; padding-right: 5px; }</style>\n';function o(t){return t===n.ORDERED?"<ol>":t===n.UNORDERED?"<ul>":'<ul class="firepad-todo">'}function s(t){return t===n.ORDERED?"</ol>":"</ul>"}function a(t){return t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u00a0/g,"&nbsp;")}return function(h,u){for(var c,l,p="",d=!0,f=[],g=!1,m=!0,y=!0,v=0,_=h.ops[v],b=!1;_;){e.assert(_.isInsert());var C=_.attributes;if(d){d=!1;var E=0,x=null,T="left";r.LINE_SENTINEL in C&&(E=C[r.LINE_INDENT]||0,x=C[r.LIST_TYPE]||null,T=C[r.LINE_ALIGN]||"left"),x&&(E=E||1),g?(p+="</li>",g=!1):m||(y&&(p+="<br/>"),p+="</div>"),m=!1,e.assert(E>=0,"Indent must not be negative.");for(;f.length>E||E===f.length&&null!==x&&(c=x,l=f[f.length-1],!(c===l||c===n.TODO&&l===n.TODOCHECKED||c===n.TODOCHECKED&&l===n.TODO));)p+=s(f.pop());for(;f.length<E;){var L=x||n.UNORDERED;b=x==n.TODO||x==n.TODOCHECKED||b,p+=o(L),f.push(L)}var w="left"!==T?' style="text-align:'+T+'"':"";if(x){var A="";switch(x){case n.TODOCHECKED:A=' class="firepad-checked"';break;case n.TODO:A=' class="firepad-unchecked"'}p+="<li"+A+w+">",g=!0}else p+="<div"+w+">";y=!0}if(r.LINE_SENTINEL in C)_=h.ops[++v];else if(r.ENTITY_SENTINEL in C){for(var M=0;M<_.text.length;M++){var N=t.Entity.fromAttributes(C);p+=u.exportToElement(N).outerHTML}_=h.ops[++v]}else{var I="",S="";for(var k in C){var R,O,F=C[k];k===r.BOLD||k===r.ITALIC||k===r.UNDERLINE||k===r.STRIKE?(e.assert(!0===F),R=O=k):k===r.FONT_SIZE?(R='span style="font-size: '+F,R+="string"!=typeof F||-1===F.indexOf("px",F.length-2)?'px"':'"',O="span"):k===r.FONT?(R='span style="font-family: '+F+'"',O="span"):k===r.COLOR?(R='span style="color: '+F+'"',O="span"):k===r.BACKGROUND_COLOR?(R='span style="background-color: '+F+'"',O="span"):e.log(!1,"Encountered unknown attribute while rendering html: "+k),R&&(I+="<"+R+">"),O&&(S="</"+O+">"+S)}var D=_.text,P=D.indexOf("\n");P>=0?(d=!0,_=P<D.length-1?new t.TextOp("insert",D.substr(P+1),C):h.ops[++v],D=D.substr(0,P)):_=h.ops[++v],(D=D.replace(/  +/g,function(t){return new Array(t.length+1).join(" ")}).replace(/^ /," ").replace(/ $/," ")).length>0&&(y=!1),p+=I+a(D)+S}}for(g?p+="</li>":m||(y&&(p+="&nbsp;"),p+="</div>");f.length>0;)p+=s(f.pop());return b&&(p=i+p),p}}(),(t=t||{}).textPiecesToInserts=function(e,r){var n=[];function i(r,i){r instanceof t.Text&&(i=r.formatting.attributes,r=r.text),n.push({string:r,attributes:i}),e="\n"===r[r.length-1]}function o(r,n){e&&i(t.sentinelConstants.LINE_SENTINEL_CHARACTER,r.formatting.attributes);for(var o=0;o<r.textPieces.length;o++)i(r.textPieces[o]);n&&i("\n")}for(var s=0;s<r.length;s++)r[s]instanceof t.Line?o(r[s],s<r.length-1):i(r[s]);return n},(t=t||{}).Firepad=function(e){if(!t.RichTextCodeMirrorAdapter)throw new Error("Oops! It looks like you're trying to include lib/firepad.js directly.  This is actually one of many source files that make up firepad.  You want dist/firepad.js instead.");var r=t.RichTextCodeMirrorAdapter,n=t.RichTextCodeMirror,i=t.RichTextToolbar,o=t.MonacoAdapter,s=t.FirebaseAdapter,a=t.EditorClient,h=t.EntityManager,u=t.AttributeConstants,c=t.utils,l=(t.LineFormatting.LIST_TYPE,e.CodeMirror),p=e.ace;e.monaco;function d(t,i,u){if(!(this instanceof d))return new d(t,i,u);if(!l&&!p&&!e.monaco)throw new Error("Couldn't find CodeMirror, ACE or Monaco.  Did you forget to include codemirror.js/ace.js or import monaco?");if(this.zombie_=!1,l&&i instanceof l){this.codeMirror_=this.editor_=i;var g=this.codeMirror_.getValue();if(""!==g)throw new Error("Can't initialize Firepad with a CodeMirror instance that already contains text.")}else if(e.monaco&&i&&i instanceof e.monaco.constructor){if(e.monaco,this.monaco_=this.editor_=i,""!==(g=this.monaco_.getValue()))throw new Error("Can't initialize Firepad with a Monaco instance that already contains text.")}else this.codeMirror_=this.editor_=new l(i);var m;m=this.codeMirror_?this.codeMirror_.getWrapperElement():this.monaco_.getDomNode(),this.firepadWrapper_=c.elt("div",null,{class:"firepad"}),m.parentNode.replaceChild(this.firepadWrapper_,m),this.firepadWrapper_.appendChild(m),c.on(m,"dragstart",c.stopEvent),this.editor_.firepad=this,this.options_=u||{},this.getOption("richTextShortcuts",!1)&&(l.keyMap.richtext||this.initializeKeyMap_(),this.codeMirror_.setOption("keyMap","richtext"),this.firepadWrapper_.className+=" firepad-richtext"),this.imageInsertionUI=this.getOption("imageInsertionUI",!0),this.showPrint=this.getOption("showPrint",!0),this.maxLineCount=this.getOption("maxLineCount",1e3),this.getOption("richTextToolbar",!1)&&(this.addToolbar_(),this.firepadWrapper_.className+=" firepad-richtext firepad-with-toolbar"),this.codeMirror_&&this.codeMirror_.refresh();var y=this.getOption("userDisplayName",v),v=this.getOption("userId",t.push().key),_=this.getOption("userColor",function(t){for(var e=1,r=0;r<t.length;r++)e=17*(e+t.charCodeAt(r))%360;return function(t,e,r){if(0===e)return f(r,r,r);var n=r<.5?r*(1+e):r+e-e*r,i=2*r-n,o=function(t){return t<0&&(t+=1),t>1&&(t-=1),6*t<1?i+6*(n-i)*t:2*t<1?n:3*t<2?i+6*(n-i)*(2/3-t):i};return f(o(t+1/3),o(t),o(t-1/3))}(e/360,1,.75)}(v));this.entityManager_=new h,this.firebaseAdapter_=new s(t,v,_,y),this.codeMirror_?(this.richTextCodeMirror_=new n(this.codeMirror_,this.entityManager_,{cssPrefix:"firepad-",maxLineCount:this.maxLineCount}),this.editorAdapter_=new r(this.richTextCodeMirror_)):this.editorAdapter_=new o(this.monaco_),this.client_=new a(this.firebaseAdapter_,this.editorAdapter_);var b=this;this.firebaseAdapter_.on("cursor",function(){b.trigger.apply(b,["cursor"].concat([].slice.call(arguments)))}),this.codeMirror_&&this.richTextCodeMirror_.on("newLine",function(){b.trigger.apply(b,["newLine"].concat([].slice.call(arguments)))}),this.firebaseAdapter_.on("ready",function(){b.ready_=!0,this.monaco_&&this.editorAdapter_.grabDocumentState();var t=b.getOption("defaultText",null);t&&b.isHistoryEmpty()&&b.setText(t),b.trigger("ready")}),this.client_.on("synced",function(t){b.trigger("synced",t)}),"Microsoft Internet Explorer"==navigator.appName&&navigator.userAgent.match(/MSIE 8\./)&&(window.onload=function(){var t=document.getElementsByTagName("head")[0],e=document.createElement("style");e.type="text/css",e.styleSheet.cssText=":before,:after{content:none !important;}",t.appendChild(e),setTimeout(function(){t.removeChild(e)},0)})}function f(t,e,r){function n(t){var e=Math.round(255*t).toString(16);return 1===e.length?"0"+e:e}return"#"+n(t)+n(e)+n(r)}return c.makeEventEmitter(d),d.fromCodeMirror=d,d.fromACE=d,d.fromMonaco=d,d.prototype.dispose=function(){this.zombie_=!0,this.codeMirror_?editorWrapper=this.codeMirror_.getWrapperElement():editorWrapper=this.monaco_.getDomNode();try{this.firepadWrapper_.removeChild(editorWrapper),this.firepadWrapper_.parentNode.replaceChild(editorWrapper,this.firepadWrapper_)}catch(t){console.log("error removing child from firepad: ",t)}this.editor_.firepad=null,this.codeMirror_&&"richtext"===this.codeMirror_.getOption("keyMap")&&this.codeMirror_.setOption("keyMap","default"),this.firebaseAdapter_.dispose(),this.editorAdapter_.detach(),this.richTextCodeMirror_&&this.richTextCodeMirror_.detach()},d.prototype.setUserId=function(t){this.firebaseAdapter_.setUserId(t)},d.prototype.setUserColor=function(t){this.firebaseAdapter_.setColor(t)},d.prototype.setUserDisplayName=function(t){this.firebaseAdapter_.setDisplayName(t)},d.prototype.getText=function(){return this.assertReady_("getText"),this.codeMirror_?this.richTextCodeMirror_.getText():this.monaco_.getModel().getValue()},d.prototype.setText=function(t){if(this.assertReady_("setText"),this.monaco_)return this.monaco_.getModel().setValue(t);this.codeMirror_.getWrapperElement().setAttribute("style","display: none"),this.codeMirror_.setValue(""),this.insertText(0,t),this.codeMirror_.getWrapperElement().setAttribute("style",""),this.codeMirror_.refresh(),this.editorAdapter_.setCursor({position:0,selectionEnd:0})},d.prototype.insertTextAtCursor=function(t){this.insertText(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),t)},d.prototype.insertText=function(e,r){c.assert(!this.monaco_,"Not supported for monaco yet."),this.assertReady_("insertText"),"[object Array]"!==Object.prototype.toString.call(r)&&(r=[r]);var n=this;n.codeMirror_.operation(function(){for(var i=0===e,o=t.textPiecesToInserts(i,r),s=0;s<o.length;s++){var a=o[s].string,h=o[s].attributes;n.richTextCodeMirror_.insertText(e,a,h),e+=a.length}})},d.prototype.getOperationForSpan=function(e,r){for(var n=this.richTextCodeMirror_.getRange(e,r),i=this.richTextCodeMirror_.getAttributeSpans(e,r),o=0,s=new t.TextOperation,a=0;a<i.length;a++)s.insert(n.substr(o,i[a].length),i[a].attributes),o+=i[a].length;return s},d.prototype.getHtml=function(){return this.getHtmlFromRange(null,null)},d.prototype.selectionHasAttributes=function(){var t=this.codeMirror_.getCursor("start"),e=this.codeMirror_.getCursor("end"),r=this.codeMirror_.indexFromPos(t),n=this.codeMirror_.indexFromPos(e);return this.rangeHasAttributes(r,n)},d.prototype.rangeHasAttributes=function(e,r){this.assertReady_("rangeHasAttributes");for(var n,i=null!=e&&null!=r?this.getOperationForSpan(e,r):this.getOperationForSpan(0,this.codeMirror_.getValue().length),o=0;o<i.ops.length;o++)for(var s in(n=i.ops[o]).attributes)if(n.attributes.hasOwnProperty(s)&&s!=u.LINE_SENTINEL)for(var a in t.AttributeConstants)if(t.AttributeConstants[a]===s)return!0;return!1},d.prototype.getHtmlFromSelection=function(){var t=this.codeMirror_.getCursor("start"),e=this.codeMirror_.getCursor("end"),r=this.codeMirror_.indexFromPos(t),n=this.codeMirror_.indexFromPos(e);return this.getHtmlFromRange(r,n)},d.prototype.getHtmlFromRange=function(e,r){this.assertReady_("getHtmlFromRange");var n=null!=e&&null!=r?this.getOperationForSpan(e,r):this.getOperationForSpan(0,this.codeMirror_.getValue().length);return t.SerializeHtml(n,this.entityManager_)},d.prototype.insertHtml=function(e,r){var n=t.ParseHtml(r,this.entityManager_,this.codeMirror_);this.insertText(e,n)},d.prototype.insertHtmlAtCursor=function(t){this.insertHtml(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),t)},d.prototype.setHtml=function(e){var r=t.ParseHtml(e,this.entityManager_,this.codeMirror_);this.setText(r)},d.prototype.isHistoryEmpty=function(){return this.assertReady_("isHistoryEmpty"),this.firebaseAdapter_.isHistoryEmpty()},d.prototype.bold=function(){this.richTextCodeMirror_.toggleAttribute(u.BOLD),this.codeMirror_.focus()},d.prototype.italic=function(){this.richTextCodeMirror_.toggleAttribute(u.ITALIC),this.codeMirror_.focus()},d.prototype.underline=function(){this.richTextCodeMirror_.toggleAttribute(u.UNDERLINE),this.codeMirror_.focus()},d.prototype.strike=function(){this.richTextCodeMirror_.toggleAttribute(u.STRIKE),this.codeMirror_.focus()},d.prototype.fontSize=function(t){this.richTextCodeMirror_.setAttribute(u.FONT_SIZE,t),this.codeMirror_.focus()},d.prototype.font=function(t){this.richTextCodeMirror_.setAttribute(u.FONT,t),this.codeMirror_.focus()},d.prototype.color=function(t){this.richTextCodeMirror_.setAttribute(u.COLOR,t),this.codeMirror_.focus()},d.prototype.highlight=function(){this.richTextCodeMirror_.toggleAttribute(u.BACKGROUND_COLOR,"rgba(255,255,0,.65)"),this.codeMirror_.focus()},d.prototype.align=function(t){if("left"!==t&&"center"!==t&&"right"!==t)throw new Error('align() must be passed "left", "center", or "right".');this.richTextCodeMirror_.setLineAttribute(u.LINE_ALIGN,t),this.codeMirror_.focus()},d.prototype.orderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(u.LIST_TYPE,"o"),this.codeMirror_.focus()},d.prototype.unorderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(u.LIST_TYPE,"u"),this.codeMirror_.focus()},d.prototype.todo=function(){this.richTextCodeMirror_.toggleTodo(),this.codeMirror_.focus()},d.prototype.newline=function(){this.richTextCodeMirror_.newline()},d.prototype.deleteLeft=function(){this.richTextCodeMirror_.deleteLeft()},d.prototype.deleteRight=function(){this.richTextCodeMirror_.deleteRight()},d.prototype.indent=function(){this.richTextCodeMirror_.indent(),this.codeMirror_.focus()},d.prototype.unindent=function(){this.richTextCodeMirror_.unindent(),this.codeMirror_.focus()},d.prototype.undo=function(){this.codeMirror_.undo()},d.prototype.redo=function(){this.codeMirror_.redo()},d.prototype.print=function(){var t,e,r,n='<div style="font-family: Verdana, sans-serif; font-size: 14px">'+this.getHtml()+"</div>";t=n,e="Team Write - "+(new Date).toLocaleString(),(r=window.open("",e,"height=1000,width=800")).document.head.innerHTML="<title>"+e+"</title>",r.document.body.innerHTML="<body>"+t+"</body>",r.document.close(),r.focus(),r.print(),r.close()},d.prototype.insertEntity=function(t,e,r){this.richTextCodeMirror_.insertEntityAtCursor(t,e,r)},d.prototype.insertEntityAt=function(t,e,r,n){this.richTextCodeMirror_.insertEntityAt(t,e,r,n)},d.prototype.registerEntity=function(t,e){this.entityManager_.register(t,e)},d.prototype.getOption=function(t,e){return t in this.options_?this.options_[t]:e},d.prototype.assertReady_=function(t){if(!this.ready_)throw new Error('You must wait for the "ready" event before calling '+t+".");if(this.zombie_)throw new Error("You can't use a Firepad after calling dispose()!  [called "+t+"]")},d.prototype.makeImageDialog_=function(){var t=this,e="inputID"+(new Date).getTime(),r=function(){var r=document.getElementById(e).value;if(null!==r&&r.length>0){var n=document.getElementById("overlay");n.style.visibility="hidden",t.insertEntity("img",{src:r}),t.firepadWrapper_.removeChild(n)}};var n=c.elt("div","Insert image URL",{class:"firepad-dialog-header"}),i=c.elt("input",null,{class:"firepad-dialog-input",id:e,type:"text",placeholder:"",autofocus:"autofocus"});c.on(i,"keyup",c.stopEventAnd(function(){var t=document.getElementById(e).value;document.getElementById("feedback").innerHTML="";var r=document.getElementById("submitbtn");null!==t&&t.length>0?r.setAttribute("class","firepad-btn"):r.setAttribute("class","firepad-btn firepad-btn-disabled")}));var o=c.elt("a","Submit",{class:"firepad-btn firepad-btn-disabled",id:"submitbtn"});c.on(o,"click",c.stopEventAnd(function(t){t=document.getElementById(e).value;var n=new Image;n.onerror=function(t){document.getElementById("feedback").innerHTML="Sorry, image could not be found."},n.onload=function(){r()},n.src=t}));var s=c.elt("a","Cancel",{class:"firepad-btn"});c.on(s,"click",c.stopEventAnd(function(){var e=document.getElementById("overlay");e.style.visibility="hidden",t.firepadWrapper_.removeChild(e)}));var a=c.elt("div","",{class:"firepad-feedback",id:"feedback"}),h=c.elt("div",[o,s],{class:"firepad-btn-group"}),u=c.elt("div",[n,i,a,h],{class:"firepad-dialog-div"}),l=c.elt("div",[u],{class:"firepad-dialog",id:"overlay"});this.firepadWrapper_.appendChild(l)},d.prototype.addToolbar_=function(){this.toolbar=new i(this.imageInsertionUI,this.showPrint),this.toolbar.on("undo",this.undo,this),this.toolbar.on("redo",this.redo,this),this.toolbar.on("bold",this.bold,this),this.toolbar.on("italic",this.italic,this),this.toolbar.on("underline",this.underline,this),this.toolbar.on("strike",this.strike,this),this.toolbar.on("font-size",this.fontSize,this),this.toolbar.on("font",this.font,this),this.toolbar.on("color",this.color,this),this.toolbar.on("left",function(){this.align("left")},this),this.toolbar.on("center",function(){this.align("center")},this),this.toolbar.on("right",function(){this.align("right")},this),this.toolbar.on("ordered-list",this.orderedList,this),this.toolbar.on("unordered-list",this.unorderedList,this),this.toolbar.on("todo-list",this.todo,this),this.toolbar.on("indent-increase",this.indent,this),this.toolbar.on("indent-decrease",this.unindent,this),this.toolbar.on("insert-image",this.makeImageDialog_,this),this.showPrint&&this.toolbar.on("print",this.print,this),this.firepadWrapper_.insertBefore(this.toolbar.element(),this.firepadWrapper_.firstChild)},d.prototype.initializeKeyMap_=function(){function t(t){return function(e){setTimeout(function(){t.call(e.firepad)},0)}}l.keyMap.richtext={"Ctrl-B":t(this.bold),"Cmd-B":t(this.bold),"Ctrl-I":t(this.italic),"Cmd-I":t(this.italic),"Ctrl-U":t(this.underline),"Cmd-U":t(this.underline),"Ctrl-H":t(this.highlight),"Cmd-H":t(this.highlight),Enter:t(this.newline),Delete:t(this.deleteRight),Backspace:t(this.deleteLeft),Tab:t(this.indent),"Shift-Tab":t(this.unindent),fallthrough:["default"]}},d}(this),t.Firepad.Formatting=t.Formatting,t.Firepad.Text=t.Text,t.Firepad.Entity=t.Entity,t.Firepad.LineFormatting=t.LineFormatting,t.Firepad.Line=t.Line,t.Firepad.TextOperation=t.TextOperation,t.Firepad.RichTextCodeMirrorAdapter=t.RichTextCodeMirrorAdapter,t.Firepad.MonacoAdapter=t.MonacoAdapter,t.Firepad},this);